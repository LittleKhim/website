<!DOCTYPE html>
<html lang="vi">
<link rel="icon" href="https://upload.wikimedia.org/wikipedia/commons/b/b5/ROBLOX_Studio_icon.png" type="image/png" />

<head>
    <meta name="og:type" content="website">
    <meta name="og:title" content="C·ª≠a H√†ng Script Roblox - Mua Script, Fix Script, L√†m Script">
    <meta name="og:description" content="C·ª≠a h√†ng chuy√™n cung c·∫•p c√°c d·ªãch v·ª• Script Roblox: Mua script, Fix script, L√†m script theo y√™u c·∫ßu.">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C·ª≠a H√†ng Script Roblox </title>
    <link rel="stylesheet" href="store-styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Appwrite SDK using ES modules -->
    <script type="module">
        import { Client, Account, OAuthProvider } from 'https://cdn.jsdelivr.net/npm/appwrite@16.0.2/+esm';
        
        // Appwrite configuration
        const APPWRITE_ENDPOINT = 'https://sgp.cloud.appwrite.io/v1';
        const APPWRITE_PROJECT_ID = '690ec5bf00043292a7e0';
        
        // Production domain
        const PRODUCTION_DOMAIN = 'https://www.thelazy.store';
        
        // Determine base URL for OAuth redirects
        // Use production domain if running on thelazy.store, otherwise use localhost
        let baseUrl;
        if (window.location.hostname === 'www.thelazy.store' || window.location.hostname === 'thelazy.store') {
            baseUrl = PRODUCTION_DOMAIN;
        } else if (window.location.protocol === 'file:') {
            // Development: use localhost with detected port
            const port = window.location.port || '5173';
            baseUrl = `http://localhost:${port}`;
        } else {
            // Development: use current origin
            baseUrl = window.location.origin;
        }
        
        // Initialize Appwrite client and account
        const appwriteClient = new Client()
            .setEndpoint(APPWRITE_ENDPOINT)
            .setProject(APPWRITE_PROJECT_ID);
        
        const appwriteAccount = new Account(appwriteClient);
        
        // Expose to global scope for use in other scripts
        window.AppwriteSDK = {
            Client,
            Account,
            OAuthProvider,
            client: appwriteClient,
            account: appwriteAccount
        };
        
        // Expose base URL for OAuth redirects
        window.OAUTH_BASE_URL = baseUrl;
        
        window.appwriteSDKLoaded = true;
        console.log('Appwrite SDK loaded successfully using ES modules');
        console.log('OAuth Base URL:', baseUrl);
        console.log('Environment:', window.location.hostname === 'www.thelazy.store' || window.location.hostname === 'thelazy.store' ? 'Production' : 'Development');
    </script>
</head>

<body>
    <nav id="main-nav" class="nav-visible">
        <div class="nav-content nav-centered">
            <ul class="nav-menu">
                <li class="nav-item-desktop"><a href="index.html" data-i18n="nav.home">Trang Ch·ªß</a></li>
                <li class="nav-item-desktop"><a href="#products" data-i18n="nav.products">S·∫£n Ph·∫©m</a></li>
                <li class="nav-item-desktop"><a href="#about" data-i18n="nav.about">V·ªÅ Ch√∫ng T√¥i</a></li>
            </ul>
        </div>
        <div class="nav-right">
            <div class="user-menu-container" id="user-menu-container" style="display: none;">
                <button class="user-menu-btn" id="user-menu-btn">
                    <span class="user-name" id="user-name"></span>
                    <span class="user-balance" id="user-balance">0‚Ç´</span>
                    <i class="fas fa-chevron-down"></i>
                </button>
                <div class="user-dropdown" id="user-dropdown">
                    <button class="user-dropdown-item" id="top-up-btn">
                        <i class="fas fa-wallet"></i> N·∫°p Ti·ªÅn
                    </button>
                    <button class="user-dropdown-item" id="settings-btn">
                        <i class="fas fa-cog"></i> C√†i ƒê·∫∑t
                    </button>
                    <button class="user-dropdown-item" id="logout-btn">
                        <i class="fas fa-sign-out-alt"></i> ƒêƒÉng Xu·∫•t
                    </button>
                </div>
            </div>
            <div id="google-signin-container" class="google-signin-container"></div>
        </div>
    </nav>

    <main id="main-content">
        <section class="store-hero">
            <h1 data-i18n="store.title">C·ª≠a H√†ng Roblox</h1>
            <p class="store-subtitle" data-i18n="store.subtitle">Mua Robux, V·∫≠t Ph·∫©m Game v·ªõi gi√° t·ªët nh·∫•t</p>
        </section>


        <!-- Shopping Cart Sidebar -->
        <div class="cart-sidebar" id="cart-sidebar">
            <div class="cart-header">
                <h2 data-i18n="cart.title">Gi·ªè H√†ng</h2>
                <button class="cart-close" id="cart-close">&times;</button>
            </div>
            <div class="cart-items" id="cart-items">
                <p class="cart-empty" data-i18n="cart.empty">Gi·ªè h√†ng tr·ªëng</p>
            </div>
            <div class="cart-footer">
                <div class="cart-total">
                    <span data-i18n="cart.total">T·ªïng c·ªông:</span>
                    <span id="cart-total-price">0‚Ç´</span>
                </div>
                <button class="cart-checkout-btn" id="checkout-btn" data-i18n="cart.checkout">Thanh To√°n</button>
            </div>
        </div>

        <!-- Order Modal -->
        <div class="order-modal-overlay" id="order-modal">
            <div class="order-modal-container">
                <button class="order-modal-close" id="order-modal-close">
                    <i class="fas fa-times"></i>
                </button>
                <div class="order-modal-content">
                    <h2 data-i18n="order.title">ƒê·∫∑t H√†ng</h2>
                    <div class="order-items-list" id="order-items-list">
                        <!-- Order items will be inserted here -->
                    </div>
                    <div class="order-total-section">
                        <div class="order-total-row">
                            <span data-i18n="order.total">T·ªïng c·ªông:</span>
                            <span id="order-total-price">0‚Ç´</span>
                        </div>
                    </div>
                    <div class="order-code-section">
                        <label data-i18n="order.codeLabel">M√£ ƒê∆°n H√†ng:</label>
                        <div class="order-code-container">
                            <input type="text" id="order-code-input" readonly>
                        </div>
                    </div>
                    <div class="order-actions">
                        <a href="#" id="facebook-order-btn" class="facebook-order-btn" target="_blank">
                            <i class="fab fa-facebook"></i>
                            <span data-i18n="order.contactFacebook">Nh·∫Øn tin Facebook v·ªõi m√£ ƒë∆°n h√†ng</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Top-Up Modal -->
        <div class="topup-modal-overlay" id="topup-modal">
            <div class="topup-modal-container">
                <button class="topup-modal-close" id="topup-modal-close">
                    <i class="fas fa-times"></i>
                </button>
                <div class="topup-modal-content">
                    <h2>N·∫°p Ti·ªÅn</h2>
                    <div class="topup-amount-section">
                        <label>S·ªë ti·ªÅn mu·ªën n·∫°p (VND):</label>
                        <input type="number" id="topup-amount" min="10000" step="10000" placeholder="Nh·∫≠p s·ªë ti·ªÅn" value="100000">
                    </div>
                    <div class="topup-info-section">
                        <h3>Th√¥ng tin chuy·ªÉn kho·∫£n:</h3>
                        <div class="topup-qr-container">
                            <div class="topup-qr-placeholder">
                                <i class="fas fa-qrcode"></i>
                                <p>QR Code s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y</p>
                                <p class="topup-note">Vui l√≤ng qu√©t QR ƒë·ªÉ chuy·ªÉn kho·∫£n</p>
                            </div>
                        </div>
                        <div class="topup-bank-info">
                            <p><strong>Ng√¢n h√†ng:</strong> <span id="topup-bank-name">Vietcombank</span></p>
                            <p><strong>S·ªë t√†i kho·∫£n:</strong> <span id="topup-account-number">1234567890</span></p>
                            <p><strong>Ch·ªß t√†i kho·∫£n:</strong> <span id="topup-account-name">NGUYEN VAN A</span></p>
                        </div>
                        <div class="topup-random-info">
                            <h4>Th√¥ng tin x√°c nh·∫≠n (b·∫Øt bu·ªôc):</h4>
                            <p class="topup-random-code">M√£ x√°c nh·∫≠n: <strong id="topup-random-code">ABC123XYZ</strong></p>
                            <p class="topup-note">Vui l√≤ng ghi ch√∫ khi chuy·ªÉn kho·∫£n: <strong id="topup-note-code">ABC123XYZ</strong></p>
                        </div>
                        <div class="topup-actions">
                            <button class="topup-confirm-btn" id="topup-confirm-btn">
                                <i class="fas fa-check"></i> ƒê√£ chuy·ªÉn kho·∫£n
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Login Required Modal -->
        <div class="login-modal-overlay" id="login-modal">
            <div class="login-modal-container">
                <div class="login-modal-content">
                    <h2>ƒêƒÉng Nh·∫≠p ƒê·ªÉ Ti·∫øp T·ª•c</h2>
                    <p>Vui l√≤ng ƒëƒÉng nh·∫≠p b·∫±ng Google ƒë·ªÉ mua h√†ng</p>
                    <div id="google-signin-modal"></div>
                </div>
            </div>
        </div>

        <div class="products-title" id="products" data-i18n="products.title">S·∫£n Ph·∫©m</div>
        
        <!-- Product Categories -->
        <div class="product-categories">
            <button class="category-btn active" data-category="all">T·∫•t C·∫£</button>
            <button class="category-btn" data-category="robux">Robux</button>
            <button class="category-btn" data-category="account">T√†i Kho·∫£n</button>
            <button class="category-btn" data-category="farming">C√†y Thu√™</button>
        </div>
        
        <section class="products-grid" id="products-grid">
            <!-- Products will be loaded dynamically -->
        </section>

        <div class="about-title" id="about" data-i18n="about.title">V·ªÅ C·ª≠a H√†ng</div>
        <section class="about-section">
            <div class="about-card">
                <i class="fas fa-shield-alt"></i>
                <h3 data-i18n="about.quality">Ch·∫•t L∆∞·ª£ng ƒê·∫£m B·∫£o</h3>
                <p data-i18n="about.qualityDesc">T·∫•t c·∫£ script ƒë·ªÅu ƒë∆∞·ª£c ki·ªÉm tra k·ªπ l∆∞·ª°ng tr∆∞·ªõc khi giao h√†ng</p>
            </div>
            <div class="about-card">
                <i class="fas fa-clock"></i>
                <h3 data-i18n="about.fast">Giao H√†ng Nhanh</h3>
                <p data-i18n="about.fastDesc">Ho√†n th√†nh trong 24-48 gi·ªù t√πy theo ƒë·ªô ph·ª©c t·∫°p</p>
            </div>
            <div class="about-card">
                <i class="fas fa-headset"></i>
                <h3 data-i18n="about.support">H·ªó Tr·ª£ 24/7</h3>
                <p data-i18n="about.supportDesc">ƒê·ªôi ng≈© h·ªó tr·ª£ lu√¥n s·∫µn s√†ng gi·∫£i ƒë√°p th·∫Øc m·∫Øc</p>
            </div>
        </section>
    </main>

    <footer class="site-footer">
        <div class="footer-main">
            <div class="footer-content">
                <div class="footer-section">
                    <div class="footer-title" data-i18n="footer.aboutTitle">V·ªÅ Ch√∫ng T√¥i</div>
                    <div class="footer-desc" data-i18n="footer.aboutDesc">C·ª≠a h√†ng chuy√™n cung c·∫•p Robux v√† v·∫≠t ph·∫©m game Roblox v·ªõi gi√° c·∫£ h·ª£p l√Ω.</div>
                    <div class="footer-location"><i class="fas fa-map-marker-alt"></i> <span data-i18n="footer.location">H√† N·ªôi, Vi·ªát Nam</span></div>
                </div>
                <div class="footer-section">
                    <div class="footer-title" data-i18n="footer.contactTitle">Li√™n H·ªá</div>
                    <div class="footer-contact">
                        <div><i class="fas fa-envelope"></i> <a href="mailto:dgkktok@gmail.com">dgkktok@gmail.com</a></div>
                        <div><i class="fab fa-facebook"></i> <a href="https://www.facebook.com/dreamisdreamforever" target="_blank" data-i18n="footer.facebook">Facebook</a></div>
                    </div>
                </div>
                <div class="footer-section">
                    <div class="footer-title" data-i18n="footer.linksTitle">Li√™n K·∫øt</div>
                    <div class="footer-links">
                        <a href="index.html" data-i18n="footer.linkHome">Trang Ch·ªß</a>
                        <a href="#products" data-i18n="footer.linkProducts">S·∫£n Ph·∫©m</a>
                        <a href="https://www.littlekhim.online/" target="_blank" data-i18n="footer.linkPortfolio">Portfolio</a>
                    </div>
                </div>
            </div>
            <div class="footer-bottom">
                <div class="footer-social-row">
                    <a href="https://x.com/dgkktok" target="_blank" title="Twitter"><i class="fab fa-twitter"></i></a>
                    <a href="https://www.facebook.com/dreamisdreamforever" target="_blank" title="Facebook"><i class="fab fa-facebook"></i></a>
                </div>
                <p>&copy; 2024 <span data-i18n="footer.copyright">C·ª≠a H√†ng Script Roblox. T·∫•t c·∫£ quy·ªÅn ƒë∆∞·ª£c b·∫£o l∆∞u.</span></p>
            </div>
        </div>
    </footer>

    <!-- Floating Navigation Buttons -->
    <div class="floating-nav-buttons">
        <a href="dev.html" class="floating-nav-btn dev-nav-btn" title="ƒê√†o T·∫°o">
            <i class="fas fa-graduation-cap"></i>
        </a>
        <a href="cheat.html" class="floating-nav-btn cheat-nav-btn" title="Cheat Code">
            <i class="fas fa-fire"></i>
        </a>
        <button class="floating-nav-btn cart-nav-btn" id="cart-icon" title="Gi·ªè H√†ng">
            <i class="fas fa-shopping-cart"></i>
            <span class="floating-cart-count" id="cart-count">0</span>
        </button>
        <a href="https://www.littlekhim.online/" target="_blank" class="floating-nav-btn portfolio-nav-btn" title="Portfolio">
            <i class="fas fa-briefcase"></i>
        </a>
    </div>

    <script>
        // Cart functionality
        let cart = [];
        // Robux rate and stock
        const ROBUX_RATE = 125; // 1 Robux = 125 VND
        const ROBUX_STOCK = 10000; // 10k Robux available
        
        // MongoDB API endpoint (Vercel serverless function)
        const API_BASE_URL = 'https://your-vercel-app.vercel.app/api'; // Replace with your Vercel API URL
        
        const products = [
            {
                id: 'robux',
                category: 'robux',
                name: { vi: "Robux", en: "Robux" },
                description: { vi: `Mua Robux theo s·ªë l∆∞·ª£ng b·∫°n mu·ªën. Rate: ${ROBUX_RATE}‚Ç´/Robux`, en: `Buy Robux in any amount. Rate: ${ROBUX_RATE}‚Ç´/Robux` },
                price: 0,
                icon: "fas fa-coins",
                isCustomRobux: true,
                rate: ROBUX_RATE,
                stock: ROBUX_STOCK,
                stockDisplay: true
            },
            {
                id: 'account',
                category: 'account',
                name: { vi: "T√†i Kho·∫£n", en: "Account" },
                description: { vi: "T√†i kho·∫£n Roblox v·ªõi c√°c v·∫≠t ph·∫©m ƒë·ªôc ƒë√°o", en: "Roblox accounts with unique items" },
                price: 0,
                icon: "fas fa-user",
                stock: 0,
                stockDisplay: true
            },
            {
                id: 'farming',
                category: 'farming',
                name: { vi: "C√†y Thu√™", en: "Farming Service" },
                description: { vi: "D·ªãch v·ª• c√†y thu√™ game Roblox theo y√™u c·∫ßu", en: "Roblox farming service on demand" },
                price: 0,
                icon: "fas fa-tractor",
                stock: 0,
                stockDisplay: true
            }
        ];
        
        // Discord webhook URL - Replace with your actual webhook URL
        const DISCORD_WEBHOOK_URL = 'YOUR_DISCORD_WEBHOOK_URL_HERE';
        
        // User management
        let currentUser = null;
        let userBalance = 0;
        
        // Appwrite references (initialized in module script above)
        let client, account;
        let buttonsRendered = false; // Flag to prevent multiple renders
        
        function initializeAppwrite() {
            // Check if Appwrite SDK is loaded
            if (!window.appwriteSDKLoaded || !window.AppwriteSDK) {
                return false;
            }
            
            // Use the pre-initialized client and account from the module
            client = window.AppwriteSDK.client;
            account = window.AppwriteSDK.account;
            
            if (!client || !account) {
                console.warn('Appwrite client or account not available');
                return false;
            }
            
            console.log('Appwrite initialized successfully');
            return true;
        }
        
        // Bank info for top-up (replace with your actual info)
        const BANK_INFO = {
            bankName: 'MBBANK',
            accountNumber: '866613102008',
            accountName: 'DUONG GIA KHIEM',
            qrCodeUrl: 'https://via.placeholder.com/300x300?text=QR+Code' // Replace with your QR code image URL
        };

        let currentLanguage = 'vi';
        const exchangeRate = 24000;

        const translations = {
            vi: {
                'nav.home': 'Trang Ch·ªß',
                'nav.products': 'S·∫£n Ph·∫©m',
                'nav.about': 'V·ªÅ Ch√∫ng T√¥i',
                'nav.portfolio': 'Portfolio',
                'nav.dev': 'ƒê√†o T·∫°o',
                'nav.cheat': 'Cheat Code',
                'store.title': 'C·ª≠a H√†ng Roblox',
                'store.subtitle': 'Mua Robux, V·∫≠t Ph·∫©m Game v·ªõi gi√° t·ªët nh·∫•t',
                'products.title': 'S·∫£n Ph·∫©m',
                'about.title': 'V·ªÅ C·ª≠a H√†ng',
                'about.quality': 'Ch·∫•t L∆∞·ª£ng ƒê·∫£m B·∫£o',
                'about.qualityDesc': 'T·∫•t c·∫£ Robux v√† v·∫≠t ph·∫©m ƒë·ªÅu ƒë∆∞·ª£c ki·ªÉm tra k·ªπ l∆∞·ª°ng tr∆∞·ªõc khi giao h√†ng',
                'about.fast': 'Giao H√†ng Nhanh',
                'about.fastDesc': 'Giao h√†ng nhanh ch√≥ng trong v√≤ng 5-15 ph√∫t',
                'about.support': 'H·ªó Tr·ª£ 24/7',
                'about.supportDesc': 'ƒê·ªôi ng≈© h·ªó tr·ª£ lu√¥n s·∫µn s√†ng gi·∫£i ƒë√°p th·∫Øc m·∫Øc',
                'cart.title': 'Gi·ªè H√†ng',
                'cart.empty': 'Gi·ªè h√†ng tr·ªëng',
                'cart.total': 'T·ªïng c·ªông:',
                'cart.checkout': 'Thanh To√°n',
                'order.title': 'ƒê·∫∑t H√†ng',
                'order.total': 'T·ªïng c·ªông:',
                'order.codeLabel': 'M√£ ƒê∆°n H√†ng:',
                'order.contactFacebook': 'Nh·∫Øn tin Facebook v·ªõi m√£ ƒë∆°n h√†ng',
                'cart.remove': 'X√≥a',
                'cart.add': 'Th√™m v√†o gi·ªè',
                'footer.aboutTitle': 'V·ªÅ Ch√∫ng T√¥i',
                'footer.aboutDesc': 'C·ª≠a h√†ng chuy√™n cung c·∫•p Robux v√† v·∫≠t ph·∫©m game Roblox v·ªõi gi√° c·∫£ h·ª£p l√Ω.',
                'footer.location': 'H√† N·ªôi, Vi·ªát Nam',
                'footer.contactTitle': 'Li√™n H·ªá',
                'footer.facebook': 'Facebook',
                'footer.linksTitle': 'Li√™n K·∫øt',
                'footer.linkHome': 'Trang Ch·ªß',
                'footer.linkProducts': 'S·∫£n Ph·∫©m',
                'footer.linkPortfolio': 'Portfolio',
                'footer.copyright': 'C·ª≠a H√†ng Roblox. T·∫•t c·∫£ quy·ªÅn ƒë∆∞·ª£c b·∫£o l∆∞u.'
            },
            en: {
                'nav.home': 'Home',
                'nav.products': 'Products',
                'nav.about': 'About',
                'nav.portfolio': 'Portfolio',
                'nav.dev': 'Training',
                'nav.cheat': 'Cheat Code',
                'store.title': 'Roblox Script Store',
                'store.subtitle': 'Buy Script, Fix Script, Create Script on demand',
                'products.title': 'Products',
                'about.title': 'About Store',
                'about.quality': 'Quality Guaranteed',
                'about.qualityDesc': 'All scripts are thoroughly tested before delivery',
                'about.fast': 'Fast Delivery',
                'about.fastDesc': 'Completed within 24-48 hours depending on complexity',
                'about.support': '24/7 Support',
                'about.supportDesc': 'Support team is always ready to answer questions',
                'cart.title': 'Shopping Cart',
                'cart.empty': 'Cart is empty',
                'cart.total': 'Total:',
                'cart.checkout': 'Checkout',
                'order.title': 'Place Order',
                'order.total': 'Total:',
                'order.codeLabel': 'Order Code:',
                'order.contactFacebook': 'Message Facebook with order code',
                'cart.remove': 'Remove',
                'cart.add': 'Add to Cart',
                'footer.aboutTitle': 'About Us',
                'footer.aboutDesc': 'Store specializing in high-quality Roblox Script services at reasonable prices.',
                'footer.location': 'Hanoi, Vietnam',
                'footer.contactTitle': 'Contact',
                'footer.facebook': 'Facebook',
                'footer.linksTitle': 'Links',
                'footer.linkHome': 'Home',
                'footer.linkProducts': 'Products',
                'footer.linkPortfolio': 'Portfolio',
                'footer.copyright': 'Roblox Script Store. All rights reserved.'
            }
        };

        function applyTranslations() {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.dataset.i18n;
                const translated = translations[currentLanguage]?.[key];
                if (translated !== undefined) {
                    el.textContent = translated;
                }
            });
        }

        function formatCurrency(amount) {
            if (currentLanguage === 'en') {
                return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount / exchangeRate);
            }
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
        }

        let currentCategory = 'all';
        
        // Load stock from MongoDB
        async function loadStockFromDB() {
            // Skip if API URL is not configured
            if (!API_BASE_URL || API_BASE_URL.includes('your-vercel-app')) {
                console.log('API not configured, using default stock values');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/stock`);
                if (response.ok) {
                    const data = await response.json();
                    // Update products stock from database
                    products.forEach(product => {
                        if (data[product.id]) {
                            product.stock = data[product.id].stock || product.stock;
                        }
                    });
                }
            } catch (error) {
                console.log('Failed to load stock from DB, using default values:', error);
            }
        }
        
        // Save user data to MongoDB
        async function saveUserToDB(userData) {
            try {
                await fetch(`${API_BASE_URL}/users`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(userData)
                });
            } catch (error) {
                console.error('Failed to save user:', error);
            }
        }
        
        function renderProducts(category = 'all') {
            const productsGrid = document.getElementById('products-grid');
            const filteredProducts = category === 'all' 
                ? products 
                : products.filter(p => p.category === category);
            
            if (filteredProducts.length === 0) {
                productsGrid.innerHTML = '<p class="no-products">Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o</p>';
                return;
            }
            
            productsGrid.innerHTML = filteredProducts.map(product => {
                const name = product.name[currentLanguage] || product.name.vi;
                const description = product.description[currentLanguage] || product.description.vi;
                
                if (product.isCustomRobux) {
                    const stockText = product.stock > 0 ? product.stock.toLocaleString() : 'H·∫øt h√†ng';
                    return `
                        <div class="product-card robux-custom-card clickable-card" data-category="${product.category}" onclick="openRobuxModal()">
                            <div class="product-header">
                                <div class="product-icon">
                                    <i class="${product.icon}"></i>
                                </div>
                                <h3 class="product-name">${name}</h3>
                            </div>
                            <div class="product-content">
                                <p class="product-description">${description}</p>
                                <div class="product-info-row">
                                    <span class="product-rate">Rate: ${product.rate}‚Ç´</span>
                                </div>
                                <div class="product-stock-row">
                                    <span class="product-stock">C√≤n l·∫°i: ${stockText}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                const stockText = product.stockDisplay && product.stock !== undefined 
                    ? (product.stock > 0 ? product.stock.toLocaleString() : 'H·∫øt h√†ng')
                    : '';
                
                return `
                    <div class="product-card clickable-card" data-category="${product.category}" onclick="openProductModal('${product.id}')">
                        <div class="product-header">
                            <div class="product-icon">
                                <i class="${product.icon}"></i>
                            </div>
                            <h3 class="product-name">${name}</h3>
                        </div>
                        <div class="product-content">
                            <p class="product-description">${description}</p>
                            ${stockText ? `<div class="product-stock-row"><span class="product-stock">C√≤n l·∫°i: ${stockText}</span></div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            applyTranslations();
        }
        
        function openRobuxModal() {
            checkLoginBeforeAction(() => {
                const quantity = prompt('Nh·∫≠p s·ªë l∆∞·ª£ng Robux b·∫°n mu·ªën mua (1-' + ROBUX_STOCK.toLocaleString() + '):');
                if (quantity && !isNaN(quantity) && parseInt(quantity) > 0 && parseInt(quantity) <= ROBUX_STOCK) {
                    const robuxAmount = parseInt(quantity);
                    const price = robuxAmount * ROBUX_RATE;
                    if (confirm(`B·∫°n mu·ªën mua ${robuxAmount.toLocaleString()} Robux v·ªõi gi√° ${formatCurrency(price)}?`)) {
                        addRobuxToCartDirect(robuxAmount, price);
                    }
                } else if (quantity) {
                    alert('S·ªë l∆∞·ª£ng kh√¥ng h·ª£p l·ªá!');
                }
            });
        }
        
        function openProductModal(productId) {
            checkLoginBeforeAction(() => {
                alert('T√≠nh nƒÉng ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn. Vui l√≤ng li√™n h·ªá qua Facebook ƒë·ªÉ ƒë·∫∑t h√†ng.');
            });
        }
        
        function addRobuxToCartDirect(robuxAmount, price) {
            const robuxProduct = products.find(p => p.id === 'robux');
            cart.push({
                id: 'robux-' + Date.now(),
                name: robuxProduct.name,
                price: price,
                quantity: 1,
                robuxAmount: robuxAmount,
                isCustomRobux: true
            });
            updateCart();
        }
        
        function updateRobuxPrice(productId) {
            const product = products.find(p => p.id === productId);
            if (!product || !product.isCustomRobux) return;
            
            const input = document.getElementById(`robux-quantity-${productId}`);
            const priceDisplay = document.getElementById(`robux-price-${productId}`);
            let quantity = parseInt(input.value) || 0;
            
            if (quantity > product.stock) {
                input.value = product.stock;
                quantity = product.stock;
            }
            
            if (quantity < 1) {
                input.value = 1;
                quantity = 1;
            }
            
            const totalPrice = quantity * product.rate;
            priceDisplay.textContent = formatCurrency(totalPrice);
        }
        
        function addRobuxToCart(productId) {
            checkLoginBeforeAction(() => {
                const product = products.find(p => p.id === productId);
                if (!product || !product.isCustomRobux) return;
                
                const input = document.getElementById(`robux-quantity-${productId}`);
                const quantity = parseInt(input.value) || 0;
                
                if (quantity < 1) {
                    alert(currentLanguage === 'vi' ? 'Vui l√≤ng nh·∫≠p s·ªë l∆∞·ª£ng Robux h·ª£p l·ªá!' : 'Please enter a valid Robux amount!');
                    return;
                }
                
                if (quantity > product.stock) {
                    alert(currentLanguage === 'vi' ? `S·ªë l∆∞·ª£ng v∆∞·ª£t qu√° stock hi·ªán c√≥ (${product.stock.toLocaleString()} Robux)!` : `Amount exceeds available stock (${product.stock.toLocaleString()} Robux)!`);
                    return;
                }
                
                const price = quantity * product.rate;
                const cartItem = {
                    ...product,
                    quantity: quantity,
                    price: price,
                    robuxAmount: quantity
                };
                
                // Check if custom Robux already in cart
                const existingIndex = cart.findIndex(item => item.id === productId);
                if (existingIndex >= 0) {
                    cart[existingIndex] = cartItem; // Replace with new quantity
                } else {
                    cart.push(cartItem);
                }
                
                updateCart();
            });
        }

        function addToCart(productId) {
            checkLoginBeforeAction(() => {
                const product = products.find(p => p.id === productId);
                if (product) {
                    // Skip if it's custom Robux (use addRobuxToCart instead)
                    if (product.isCustomRobux) {
                        addRobuxToCart(productId);
                        return;
                    }
                    
                    const existingItem = cart.find(item => item.id === productId);
                    if (existingItem) {
                        existingItem.quantity += 1;
                    } else {
                        cart.push({ ...product, quantity: 1 });
                    }
                    updateCart();
                }
            });
        }

        function removeFromCart(productId) {
            cart = cart.filter(item => item.id !== productId);
            updateCart();
        }

        function updateCart() {
            const cartCount = document.getElementById('cart-count');
            const cartItems = document.getElementById('cart-items');
            const cartTotalPrice = document.getElementById('cart-total-price');

            cartCount.textContent = cart.reduce((sum, item) => sum + item.quantity, 0);

            if (cart.length === 0) {
                cartItems.innerHTML = `<p class="cart-empty" data-i18n="cart.empty">Gi·ªè h√†ng tr·ªëng</p>`;
            } else {
                cartItems.innerHTML = cart.map(item => {
                    const name = item.name[currentLanguage] || item.name.vi;
                    const displayName = item.isCustomRobux && item.robuxAmount 
                        ? `${name} (${item.robuxAmount.toLocaleString()} Robux)`
                        : name;
                    return `
                        <div class="cart-item">
                            <div class="cart-item-info">
                                <h4>${displayName}</h4>
                                <p>${formatCurrency(item.price)}${item.quantity > 1 ? ` x ${item.quantity}` : ''}</p>
                            </div>
                            <div class="cart-item-actions">
                                <button class="cart-remove-btn" onclick="removeFromCart(${typeof item.id === 'string' ? `'${item.id}'` : item.id})" data-i18n="cart.remove">X√≥a</button>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            cartTotalPrice.textContent = formatCurrency(total);
            applyTranslations();
        }

        function openCart() {
            document.getElementById('cart-sidebar').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeCart() {
            document.getElementById('cart-sidebar').classList.remove('active');
            document.body.style.overflow = '';
        }

        function generateOrderCode() {
            const timestamp = Date.now();
            const random = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
            return `ORD-${timestamp}-${random}`;
        }

        function openOrderModal() {
            if (cart.length === 0) {
                alert(currentLanguage === 'vi' ? 'Gi·ªè h√†ng tr·ªëng!' : 'Cart is empty!');
                return;
            }
            
            const orderModal = document.getElementById('order-modal');
            const orderCode = generateOrderCode();
            const orderCodeInput = document.getElementById('order-code-input');
            const orderItemsList = document.getElementById('order-items-list');
            const orderTotalPrice = document.getElementById('order-total-price');
            
            // Set order code
            orderCodeInput.value = orderCode;
            
            // Display order items
            const itemsHtml = cart.map(item => {
                const name = item.name[currentLanguage] || item.name.vi;
                const displayName = item.isCustomRobux && item.robuxAmount 
                    ? `${name} (${item.robuxAmount.toLocaleString()} Robux)`
                    : name;
                const itemTotal = item.price * item.quantity;
                return `
                    <div class="order-item-row">
                        <span class="order-item-name">${displayName} x${item.quantity}</span>
                        <span class="order-item-price">${formatCurrency(itemTotal)}</span>
                    </div>
                `;
            }).join('');
            orderItemsList.innerHTML = itemsHtml;
            
            // Calculate and display total
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            orderTotalPrice.textContent = formatCurrency(total);
            
            // Update Facebook link with order code
            const facebookBtn = document.getElementById('facebook-order-btn');
            const facebookLink = 'https://m.me/dreamisdreamforever';
            const message = encodeURIComponent(`Xin ch√†o! T√¥i mu·ªën ƒë·∫∑t h√†ng v·ªõi m√£ ƒë∆°n h√†ng: ${orderCode}`);
            facebookBtn.href = `${facebookLink}?text=${message}`;
            
            // Send Discord webhook
            sendDiscordWebhook(orderCode, cart, total);
            
            // Show modal
            orderModal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }
        
        async function sendDiscordWebhook(orderCode, cartItems, total) {
            if (!DISCORD_WEBHOOK_URL || DISCORD_WEBHOOK_URL === 'YOUR_DISCORD_WEBHOOK_URL_HERE') {
                console.warn('Discord webhook URL not configured');
                return;
            }
            
            const itemsList = cartItems.map(item => {
                const name = item.name[currentLanguage] || item.name.vi;
                const displayName = item.isCustomRobux && item.robuxAmount 
                    ? `${name} (${item.robuxAmount.toLocaleString()} Robux)`
                    : name;
                return `- ${displayName} x${item.quantity} - ${formatCurrency(item.price * item.quantity)}`;
            }).join('\n');
            
            const embed = {
                title: 'üõí ƒê∆°n H√†ng M·ªõi',
                description: `M√£ ƒë∆°n h√†ng: **${orderCode}**`,
                color: 0x4caf50,
                fields: [
                    {
                        name: 'üì¶ S·∫£n Ph·∫©m',
                        value: itemsList || 'Kh√¥ng c√≥ s·∫£n ph·∫©m',
                        inline: false
                    },
                    {
                        name: 'üí∞ T·ªïng Ti·ªÅn',
                        value: formatCurrency(total),
                        inline: true
                    },
                    {
                        name: 'üïê Th·ªùi Gian',
                        value: new Date().toLocaleString('vi-VN'),
                        inline: true
                    }
                ],
                timestamp: new Date().toISOString()
            };
            
            try {
                await fetch(DISCORD_WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        embeds: [embed]
                    })
                });
            } catch (error) {
                console.error('Failed to send Discord webhook:', error);
            }
        }

        function closeOrderModal() {
            const orderModal = document.getElementById('order-modal');
            orderModal.style.display = 'none';
            document.body.style.overflow = '';
        }


        function checkout() {
            openOrderModal();
        }
        
        // User management functions
        async function loadUserData() {
            // First check Appwrite session
            await checkUserSession();
            
            // If no Appwrite session, check localStorage
            if (!currentUser) {
                const savedUser = localStorage.getItem('store_user');
                const savedBalance = localStorage.getItem('store_balance');
                
                if (savedUser) {
                    currentUser = JSON.parse(savedUser);
                    userBalance = savedBalance ? parseFloat(savedBalance) : 0;
                    showUserMenu();
                } else {
                    showLoginButton();
                }
            }
            
            // Handle OAuth callback if present
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('error') === 'auth_failed') {
                alert('ƒêƒÉng nh·∫≠p th·∫•t b·∫°i. Vui l√≤ng th·ª≠ l·∫°i.');
                // Clean URL
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }
        
        function saveUserData() {
            if (currentUser) {
                localStorage.setItem('store_user', JSON.stringify(currentUser));
                localStorage.setItem('store_balance', userBalance.toString());
            }
        }
        
        function showUserMenu() {
            const userMenuContainer = document.getElementById('user-menu-container');
            const signinContainer = document.getElementById('google-signin-container');
            
            if (userMenuContainer) userMenuContainer.style.display = 'block';
            if (signinContainer) signinContainer.style.display = 'none';
            
            const userNameEl = document.getElementById('user-name');
            const userBalanceEl = document.getElementById('user-balance');
            if (userNameEl) userNameEl.textContent = currentUser.name || currentUser.email;
            if (userBalanceEl) userBalanceEl.textContent = formatCurrency(userBalance);
        }
        
        function showLoginButton() {
            const userMenuContainer = document.getElementById('user-menu-container');
            const signinContainer = document.getElementById('google-signin-container');
            
            if (userMenuContainer) userMenuContainer.style.display = 'none';
            if (signinContainer) {
                signinContainer.style.display = 'flex'; // Use flex to match CSS
                // Ensure button is rendered (only if not already rendered)
                if (!buttonsRendered) {
                    initializeGoogleSignIn();
                }
            }
        }
        
        async function logout() {
            try {
                if (account) {
                    await account.deleteSession('current');
                }
            } catch (error) {
                console.error('Error logging out from Appwrite:', error);
            }
            currentUser = null;
            userBalance = 0;
            localStorage.removeItem('store_user');
            localStorage.removeItem('store_balance');
            showLoginButton();
        }
        
        function generateRandomCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 9; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }
        
        function openTopUpModal() {
            const modal = document.getElementById('topup-modal');
            const randomCode = generateRandomCode();
            
            document.getElementById('topup-bank-name').textContent = BANK_INFO.bankName;
            document.getElementById('topup-account-number').textContent = BANK_INFO.accountNumber;
            document.getElementById('topup-account-name').textContent = BANK_INFO.accountName;
            document.getElementById('topup-random-code').textContent = randomCode;
            document.getElementById('topup-note-code').textContent = randomCode;
            
            // Update QR code (you can replace this with actual QR code generation)
            const qrContainer = document.querySelector('.topup-qr-placeholder');
            qrContainer.innerHTML = `
                <img src="${BANK_INFO.qrCodeUrl}" alt="QR Code" style="max-width: 300px; height: auto; border-radius: 0.5rem;">
                <p class="topup-note">Vui l√≤ng qu√©t QR ƒë·ªÉ chuy·ªÉn kho·∫£n</p>
            `;
            
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }
        
        function closeTopUpModal() {
            document.getElementById('topup-modal').style.display = 'none';
            document.body.style.overflow = '';
        }
        
        function confirmTopUp() {
            const amount = parseFloat(document.getElementById('topup-amount').value);
            if (amount < 10000) {
                alert('S·ªë ti·ªÅn t·ªëi thi·ªÉu l√† 10,000‚Ç´');
                return;
            }
            
            // In real app, you would verify the payment here
            userBalance += amount;
            saveUserData();
            document.getElementById('user-balance').textContent = formatCurrency(userBalance);
            closeTopUpModal();
            alert(`ƒê√£ n·∫°p th√†nh c√¥ng ${formatCurrency(amount)}!`);
        }
        
        function checkLoginBeforeAction(callback) {
            if (!currentUser) {
                document.getElementById('login-modal').style.display = 'flex';
                return;
            }
            callback();
        }
        
        function initializeGoogleSignIn() {
            // Render sign-in buttons only once
            if (!buttonsRendered) {
                renderGoogleSignInButton('google-signin-container');
                renderGoogleSignInButton('google-signin-modal');
                buttonsRendered = true;
            }
            
            // Try to initialize Appwrite if not already done
            if (!account) {
                const initialized = initializeAppwrite();
                if (!initialized) {
                    // Wait for Appwrite SDK to load
                    setTimeout(initializeGoogleSignIn, 100);
                    return;
                }
            }
            
            // Check if user is already logged in
            if (account) {
                checkUserSession();
            }
        }
        
        function renderGoogleSignInButton(containerId) {
            const container = document.getElementById(containerId);
            if (!container) {
                return;
            }
            
            // Ensure container is visible
            if (containerId === 'google-signin-container') {
                container.style.display = 'flex';
            }
            
            // Clear existing content
            container.innerHTML = '';
            
            // Create button
            const button = document.createElement('button');
            button.className = 'google-signin-btn';
            button.type = 'button'; // Prevent form submission
            button.innerHTML = `
                <svg width="18" height="18" xmlns="http://www.w3.org/2000/svg">
                    <g fill="#000" fill-rule="evenodd">
                        <path d="M9 3.48c1.69 0 2.83.73 3.48 1.34l2.54-2.48C13.46.89 11.43 0 9 0 5.48 0 2.44 2.02.96 4.96l2.91 2.26C4.6 5.05 6.62 3.48 9 3.48z" fill="#EA4335"/>
                        <path d="M17.64 9.2c0-.74-.06-1.28-.19-1.84H9v3.34h4.96c-.21 1.18-.84 2.18-1.79 2.91l2.78 2.15c2.17-2 3.69-4.94 3.69-8.56z" fill="#4285F4"/>
                        <path d="M3.88 10.78A5.54 5.54 0 0 1 3.58 9c0-.62.11-1.22.29-1.78L.96 4.96A9.008 9.008 0 0 0 0 9c0 1.45.35 2.82.96 4.04l2.92-2.26z" fill="#FBBC05"/>
                        <path d="M9 18c2.43 0 4.47-.8 5.96-2.18l-2.78-2.15c-.76.53-1.78.9-3.18.9-2.38 0-4.4-1.57-5.12-3.74L.96 13.04C2.45 15.98 5.48 18 9 18z" fill="#34A853"/>
                    </g>
                </svg>
                <span>ƒêƒÉng nh·∫≠p v·ªõi Google</span>
            `;
            button.onclick = handleGoogleSignIn;
            container.appendChild(button);
        }
        
        async function handleGoogleSignIn() {
            // Check if Appwrite SDK is loaded
            if (!window.AppwriteSDK || !window.appwriteSDKLoaded) {
                alert('Appwrite SDK ch∆∞a ƒë∆∞·ª£c t·∫£i. Vui l√≤ng:\n1. Ki·ªÉm tra k·∫øt n·ªëi internet\n2. L√†m m·ªõi trang v√† ƒë·ª£i m·ªôt ch√∫t\n3. Ki·ªÉm tra Console (F12) ƒë·ªÉ xem l·ªói');
                return;
            }
            
            // Check if running from file:// protocol (not supported by Appwrite OAuth)
            if (window.location.protocol === 'file:') {
                const message = '‚ö†Ô∏è B·∫°n ƒëang m·ªü file tr·ª±c ti·∫øp t·ª´ m√°y t√≠nh (file://).\n\n' +
                    'Appwrite OAuth y√™u c·∫ßu ch·∫°y qua web server (HTTP/HTTPS).\n\n' +
                    'Vui l√≤ng ch·∫°y m·ªôt trong c√°c c√°ch sau:\n\n' +
                    '1. VS Code: C√†i extension "Live Server" v√† click "Go Live"\n' +
                    '2. Python: python -m http.server 8000\n' +
                    '3. Node.js: npx http-server\n\n' +
                    'Sau ƒë√≥ m·ªü http://localhost:8000/store.html';
                alert(message);
                return;
            }
            
            // Check if origin is valid (not null or empty)
            if (!window.location.origin || window.location.origin === 'null') {
                alert('‚ö†Ô∏è Kh√¥ng th·ªÉ x√°c ƒë·ªãnh URL hi·ªán t·∫°i. Vui l√≤ng ch·∫°y website qua web server (localhost).');
                return;
            }
            
            // Try to initialize Appwrite if not already done
            if (!account) {
                const initialized = initializeAppwrite();
                if (!initialized) {
                    alert('Kh√¥ng th·ªÉ kh·ªüi t·∫°o Appwrite. Vui l√≤ng ki·ªÉm tra Console (F12) ƒë·ªÉ xem l·ªói chi ti·∫øt.');
                    return;
                }
            }
            
            try {
                // Get Appwrite SDK reference
                const AppwriteSDK = window.AppwriteSDK;
                
                // Get base URL (production domain or localhost for development)
                let baseUrl = window.OAUTH_BASE_URL;
                
                // Fallback: determine base URL if not set
                if (!baseUrl) {
                    if (window.location.hostname === 'www.thelazy.store' || window.location.hostname === 'thelazy.store') {
                        baseUrl = 'https://www.thelazy.store';
                    } else if (window.location.protocol === 'file:') {
                        const port = window.location.port || '5173';
                        baseUrl = `http://localhost:${port}`;
                    } else {
                        baseUrl = window.location.origin;
                    }
                }
                
                // Build OAuth redirect URLs
                const successUrl = baseUrl + window.location.pathname;
                const failureUrl = baseUrl + window.location.pathname + '?error=auth_failed';
                
                // Validate URLs
                if (!successUrl.startsWith('http://') && !successUrl.startsWith('https://')) {
                    alert('‚ö†Ô∏è URL kh√¥ng h·ª£p l·ªá: ' + successUrl + '\n\nVui l√≤ng ch·∫°y website qua web server (localhost) ho·∫∑c tr√™n domain thelazy.store.');
                    return;
                }
                
                console.log('Initiating Google OAuth with:', {
                    successUrl: successUrl,
                    failureUrl: failureUrl,
                    baseUrl: baseUrl,
                    environment: baseUrl.includes('thelazy.store') ? 'Production' : 'Development'
                });
                
                // Important: Make sure these URLs are registered in:
                // 1. Appwrite Console ‚Üí Settings ‚Üí Platforms
                //    - Production: Add https://www.thelazy.store
                //    - Development: Add localhost with your port
                // 2. Google Cloud Console ‚Üí APIs & Services ‚Üí Credentials ‚Üí OAuth 2.0 Client IDs ‚Üí Authorized redirect URIs
                //    Add: https://sgp.cloud.appwrite.io/v1/account/sessions/oauth2/google
                console.log('‚ö†Ô∏è IMPORTANT: Make sure these URLs are registered:');
                console.log('   Appwrite Platform:', successUrl);
                console.log('   Google OAuth Redirect URI:', 'https://sgp.cloud.appwrite.io/v1/account/sessions/oauth2/google');
                
                // Create OAuth2 session with Google
                account.createOAuth2Session(
                    AppwriteSDK.OAuthProvider.Google,
                    successUrl,
                    failureUrl
                );
            } catch (error) {
                console.error('Error initiating Google sign-in:', error);
                alert('C√≥ l·ªói x·∫£y ra khi ƒëƒÉng nh·∫≠p:\n' + (error.message || error.toString()) + '\n\nVui l√≤ng ki·ªÉm tra Console (F12) ƒë·ªÉ xem chi ti·∫øt.');
            }
        }
        
        async function checkUserSession() {
            // Try to initialize Appwrite if not already done
            if (!account) {
                const initialized = initializeAppwrite();
                if (!initialized) {
                    return;
                }
            }
            
            try {
                const user = await account.get();
                
                currentUser = {
                    email: user.email,
                    name: user.name || user.email,
                    picture: '', // Appwrite doesn't provide picture by default
                    sub: user.$id
                };
                
                // Load existing balance or start with 0
                const savedBalance = localStorage.getItem('store_balance');
                userBalance = savedBalance ? parseFloat(savedBalance) : 0;
                
                saveUserData();
                showUserMenu();
                document.getElementById('login-modal').style.display = 'none';
            } catch (error) {
                // User is not logged in, show login button
                console.log('User not logged in');
            }
        }
        
        // User menu toggle
        function toggleUserMenu() {
            const dropdown = document.getElementById('user-dropdown');
            dropdown.classList.toggle('show');
        }
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const userMenu = document.getElementById('user-menu-container');
            const dropdown = document.getElementById('user-dropdown');
            if (userMenu && !userMenu.contains(event.target) && dropdown.classList.contains('show')) {
                dropdown.classList.remove('show');
            }
        });

        // Header scroll behavior
        let lastScroll = 0;
        const nav = document.getElementById('main-nav');
        
        window.addEventListener('scroll', () => {
            const currentScroll = window.pageYOffset;
            
            if (currentScroll <= 10) {
                nav.classList.add('nav-visible');
                nav.classList.remove('nav-hidden');
            } else if (currentScroll > lastScroll && currentScroll > 100) {
                nav.classList.add('nav-hidden');
                nav.classList.remove('nav-visible');
            } else {
                nav.classList.add('nav-visible');
                nav.classList.remove('nav-hidden');
            }
            
            lastScroll = currentScroll;
        });

        // Category filter
        document.addEventListener('DOMContentLoaded', () => {
            // Check if running from file:// and show warning
            if (window.location.protocol === 'file:') {
                console.warn('‚ö†Ô∏è ƒêang ch·∫°y t·ª´ file:// - OAuth s·∫Ω kh√¥ng ho·∫°t ƒë·ªông!');
                console.warn('Vui l√≤ng ch·∫°y qua web server:');
                console.warn('  - VS Code: C√†i "Live Server" extension');
                console.warn('  - Python: python -m http.server 8000');
                console.warn('  - Node.js: npx http-server');
                console.warn('Sau ƒë√≥ m·ªü: http://localhost:8000/store.html');
            }
            
            // Initialize Google sign-in buttons immediately
            initializeGoogleSignIn();
            
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentCategory = btn.dataset.category;
                    renderProducts(currentCategory);
                });
            });
            
            loadUserData();
            loadStockFromDB();
            renderProducts();
            updateCart();
            applyTranslations();

            document.getElementById('cart-icon').addEventListener('click', () => {
                checkLoginBeforeAction(openCart);
            });
            document.getElementById('cart-close').addEventListener('click', closeCart);
            document.getElementById('checkout-btn').addEventListener('click', () => {
                checkLoginBeforeAction(checkout);
            });
            document.getElementById('order-modal-close').addEventListener('click', closeOrderModal);
            document.getElementById('user-menu-btn').addEventListener('click', toggleUserMenu);
            document.getElementById('top-up-btn').addEventListener('click', openTopUpModal);
            document.getElementById('topup-modal-close').addEventListener('click', closeTopUpModal);
            document.getElementById('topup-confirm-btn').addEventListener('click', confirmTopUp);
            document.getElementById('logout-btn').addEventListener('click', logout);
            document.getElementById('settings-btn').addEventListener('click', () => {
                alert('T√≠nh nƒÉng c√†i ƒë·∫∑t ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn');
            });
            
            // Close modals when clicking outside
            document.getElementById('order-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeOrderModal();
                }
            });
            
            document.getElementById('topup-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeTopUpModal();
                }
            });
            
            document.getElementById('login-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    this.style.display = 'none';
                }
            });

            document.getElementById('cart-sidebar').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeCart();
                }
            });
        });
    </script>
</body>
</html>

