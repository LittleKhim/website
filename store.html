<!DOCTYPE html>
<html lang="vi">
<link rel="icon" href="https://upload.wikimedia.org/wikipedia/commons/b/b5/ROBLOX_Studio_icon.png" type="image/png" />

<head>
    <meta name="og:type" content="website">
    <meta name="og:title" content="Cửa Hàng Script Roblox - Mua Script, Fix Script, Làm Script">
    <meta name="og:description" content="Cửa hàng chuyên cung cấp các dịch vụ Script Roblox: Mua script, Fix script, Làm script theo yêu cầu.">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cửa Hàng Script Roblox </title>
    <link rel="stylesheet" href="store-styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Appwrite SDK using ES modules -->
    <script type="module">
        import { Client, Account, OAuthProvider } from 'https://cdn.jsdelivr.net/npm/appwrite@16.0.2/+esm';
        
        // Appwrite configuration
        const APPWRITE_ENDPOINT = 'https://sgp.cloud.appwrite.io/v1';
        const APPWRITE_PROJECT_ID = '690ec5bf00043292a7e0';
        
        // Production domain
        const PRODUCTION_DOMAIN = 'https://www.thelazy.store';
        
        // Determine base URL for OAuth redirects
        // Use production domain if running on thelazy.store, otherwise use localhost
        let baseUrl;
        if (window.location.hostname === 'www.thelazy.store' || window.location.hostname === 'thelazy.store') {
            baseUrl = PRODUCTION_DOMAIN;
        } else if (window.location.protocol === 'file:') {
            // Development: use localhost with detected port
            const port = window.location.port || '5173';
            baseUrl = `http://localhost:${port}`;
        } else {
            // Development: use current origin
            baseUrl = window.location.origin;
        }
        
        // Initialize Appwrite client and account
        const appwriteClient = new Client()
            .setEndpoint(APPWRITE_ENDPOINT)
            .setProject(APPWRITE_PROJECT_ID);
        
        const appwriteAccount = new Account(appwriteClient);
        
        // Expose to global scope for use in other scripts
        window.AppwriteSDK = {
            Client,
            Account,
            OAuthProvider,
            client: appwriteClient,
            account: appwriteAccount
        };
        
        // Expose base URL for OAuth redirects
        window.OAUTH_BASE_URL = baseUrl;
        
        window.appwriteSDKLoaded = true;
        console.log('Appwrite SDK loaded successfully using ES modules');
        console.log('OAuth Base URL:', baseUrl);
        console.log('Environment:', window.location.hostname === 'www.thelazy.store' || window.location.hostname === 'thelazy.store' ? 'Production' : 'Development');
    </script>
</head>

<body>
    <nav id="main-nav" class="nav-visible">
        <div class="nav-content nav-centered">
            <ul class="nav-menu">
                <li class="nav-item-desktop"><a href="index.html" data-i18n="nav.home">Trang Chủ</a></li>
                <li class="nav-item-desktop"><a href="#products" data-i18n="nav.products">Sản Phẩm</a></li>
                <li class="nav-item-desktop"><a href="#about" data-i18n="nav.about">Về Chúng Tôi</a></li>
            </ul>
        </div>
        <div class="nav-right">
            <div class="user-menu-container" id="user-menu-container" style="display: none;">
                <button class="user-menu-btn" id="user-menu-btn">
                    <span class="user-name" id="user-name"></span>
                    <span class="user-balance" id="user-balance">0₫</span>
                    <i class="fas fa-chevron-down"></i>
                </button>
                <div class="user-dropdown" id="user-dropdown">
                    <button class="user-dropdown-item" id="top-up-btn">
                        <i class="fas fa-wallet"></i> Nạp Tiền
                    </button>
                    <button class="user-dropdown-item" id="transaction-history-btn">
                        <i class="fas fa-history"></i> Lịch Sử Giao Dịch
                    </button>
                    <button class="user-dropdown-item" id="settings-btn">
                        <i class="fas fa-cog"></i> Cài Đặt
                    </button>
                    <button class="user-dropdown-item" id="admin-panel-btn" style="display: none;">
                        <i class="fas fa-shield-alt"></i> Admin Panel
                    </button>
                    <button class="user-dropdown-item" id="logout-btn">
                        <i class="fas fa-sign-out-alt"></i> Đăng Xuất
                    </button>
                </div>
            </div>
            <div id="google-signin-container" class="google-signin-container"></div>
        </div>
    </nav>

    <main id="main-content">
        <section class="store-hero">
            <h1 data-i18n="store.title">Cửa Hàng Roblox</h1>
            <p class="store-subtitle" data-i18n="store.subtitle">Mua Robux, Vật Phẩm Game với giá tốt nhất</p>
        </section>


        <!-- Shopping Cart Sidebar -->
        <div class="cart-sidebar" id="cart-sidebar">
            <div class="cart-header">
                <h2 data-i18n="cart.title">Giỏ Hàng</h2>
                <button class="cart-close" id="cart-close">&times;</button>
            </div>
            <div class="cart-items" id="cart-items">
                <p class="cart-empty" data-i18n="cart.empty">Giỏ hàng trống</p>
            </div>
            <div class="cart-footer">
                <div class="cart-total">
                    <span data-i18n="cart.total">Tổng cộng:</span>
                    <span id="cart-total-price">0₫</span>
                </div>
                <button class="cart-checkout-btn" id="checkout-btn" data-i18n="cart.checkout">Thanh Toán</button>
            </div>
        </div>

        <!-- Order Modal -->
        <div class="order-modal-overlay" id="order-modal">
            <div class="order-modal-container">
                <button class="order-modal-close" id="order-modal-close">
                    <i class="fas fa-times"></i>
                </button>
                <div class="order-modal-content">
                    <h2 data-i18n="order.title">Đặt Hàng</h2>
                    <div class="order-items-list" id="order-items-list">
                        <!-- Order items will be inserted here -->
                    </div>
                    <div class="order-total-section">
                        <div class="order-total-row">
                            <span data-i18n="order.total">Tổng cộng:</span>
                            <span id="order-total-price">0₫</span>
                        </div>
                    </div>
                    <div class="order-code-section">
                        <label data-i18n="order.codeLabel">Mã Đơn Hàng:</label>
                        <div class="order-code-container">
                            <input type="text" id="order-code-input" readonly>
                        </div>
                    </div>
                    <div class="order-actions">
                        <a href="#" id="facebook-order-btn" class="facebook-order-btn" target="_blank">
                            <i class="fab fa-facebook"></i>
                            <span data-i18n="order.contactFacebook">Nhắn tin Facebook với mã đơn hàng</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Top-Up Modal -->
        <div class="topup-modal-overlay" id="topup-modal">
            <div class="topup-modal-container">
                <button class="topup-modal-close" id="topup-modal-close">
                    <i class="fas fa-times"></i>
                </button>
                <div class="topup-modal-content">
                    <h2>Nạp Tiền</h2>
                    <div class="topup-amount-section">
                        <label>Số tiền muốn nạp (VND):</label>
                        <input type="number" id="topup-amount" min="10000" step="10000" placeholder="Nhập số tiền" value="100000">
                    </div>
                    <div class="topup-info-section">
                        <h3>Thông tin chuyển khoản:</h3>
                        <div class="topup-qr-container">
                            <div class="topup-qr-placeholder">
                                <i class="fas fa-qrcode"></i>
                                <p>QR Code sẽ hiển thị ở đây</p>
                                <p class="topup-note">Vui lòng quét QR để chuyển khoản</p>
                            </div>
                        </div>
                        <div class="topup-bank-info">
                            <p><strong>Ngân hàng:</strong> <span id="topup-bank-name">MBBANK</span></p>
                            <p><strong>Số tài khoản:</strong> <span id="topup-account-number">0349517085</span></p>
                            <p><strong>Chủ tài khoản:</strong> <span id="topup-account-name">DUONG GIA KHIEM</span></p>
                        </div>
                        <div class="topup-random-info">
                            <h4>Thông tin xác nhận (bắt buộc):</h4>
                            <p class="topup-random-code">Mã xác nhận: <strong id="topup-random-code">ABC123XYZ</strong></p>
                            <p class="topup-note">Vui lòng ghi chú khi chuyển khoản: <strong id="topup-note-code">ABC123XYZ</strong></p>
                        </div>
                        <div class="topup-actions">
                            <button class="topup-confirm-btn" id="topup-confirm-btn">
                                <i class="fas fa-check"></i> Đã chuyển khoản
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Login Required Modal -->
        <div class="login-modal-overlay" id="login-modal">
            <div class="login-modal-container">
                <div class="login-modal-content">
                    <h2>Đăng Nhập Để Tiếp Tục</h2>
                    <p>Vui lòng đăng nhập bằng Google để mua hàng</p>
                    <div id="google-signin-modal"></div>
                </div>
            </div>
        </div>

        <!-- Notification Modal with Blur Background -->
        <div class="notification-overlay" id="notification-overlay" style="display: none;">
            <div class="notification-container">
                <div class="notification-header">
                    <i class="fas fa-bell notification-icon"></i>
                    <button class="notification-close" id="notification-close">&times;</button>
                </div>
                <div class="notification-content" id="notification-content">
                    <!-- Notification content will be inserted here -->
                </div>
                <div class="notification-actions" id="notification-actions">
                    <!-- Action buttons will be inserted here -->
                </div>
            </div>
        </div>

        <!-- Transaction History Modal -->
        <div class="transaction-modal-overlay" id="transaction-modal" style="display: none;">
            <div class="transaction-modal-container">
                <div class="transaction-modal-header">
                    <h2><i class="fas fa-history"></i> Lịch Sử Giao Dịch</h2>
                    <button class="transaction-modal-close" id="transaction-modal-close">&times;</button>
                </div>
                <div class="transaction-modal-content">
                    <div id="transaction-history-list">
                        <!-- Transactions will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Banned User Modal -->
        <div class="banned-modal-overlay" id="banned-modal" style="display: none;">
            <div class="banned-modal-container">
                <div class="banned-modal-header">
                    <i class="fas fa-ban"></i>
                    <h2>Bạn đã bị cấm</h2>
                </div>
                <div class="banned-modal-content">
                    <p>Bạn đã bị cấm sử dụng store vĩnh viễn</p>
                    <button class="banned-logout-btn" onclick="handleLogout()">Đăng Xuất</button>
                </div>
            </div>
        </div>

        <!-- Auto Robux Subscription Plans Modal -->
        <div class="subscription-plans-modal-overlay" id="subscription-plans-modal" style="display: none;">
            <div class="subscription-plans-modal-container">
                <div class="subscription-plans-modal-header">
                    <h2><i class="fas fa-sync-alt"></i> Chọn Gói Robux Tự Động</h2>
                    <button class="subscription-plans-modal-close" id="subscription-plans-modal-close">&times;</button>
                </div>
                <div class="subscription-plans-modal-content">
                    <p class="subscription-info">Dịch vụ cung cấp Robux liên tục mỗi ngày vào gamepass của bạn</p>
                    <div class="subscription-plans-grid">
                        <div class="subscription-plan-card" data-plan="100000" onclick="selectSubscriptionPlan(100000)">
                            <div class="plan-header">
                                <h3>Gói Cơ Bản</h3>
                                <div class="plan-price">100,000₫<span>/tháng</span></div>
                            </div>
                            <div class="plan-features">
                                <p><i class="fas fa-check"></i> Cung cấp Robux mỗi ngày</p>
                                <p><i class="fas fa-check"></i> Tự động vào gamepass</p>
                            </div>
                        </div>
                        <div class="subscription-plan-card plan-recommended" data-plan="300000" onclick="selectSubscriptionPlan(300000)">
                            <div class="plan-badge">Phổ Biến</div>
                            <div class="plan-header">
                                <h3>Gói Tiêu Chuẩn</h3>
                                <div class="plan-price">300,000₫<span>/tháng</span></div>
                            </div>
                            <div class="plan-features">
                                <p><i class="fas fa-check"></i> Cung cấp Robux mỗi ngày</p>
                                <p><i class="fas fa-check"></i> Tự động vào gamepass</p>
                            </div>
                        </div>
                        <div class="subscription-plan-card" data-plan="500000" onclick="selectSubscriptionPlan(500000)">
                            <div class="plan-header">
                                <h3>Gói Cao Cấp</h3>
                                <div class="plan-price">500,000₫<span>/tháng</span></div>
                            </div>
                            <div class="plan-features">
                                <p><i class="fas fa-check"></i> Cung cấp Robux mỗi ngày</p>
                                <p><i class="fas fa-check"></i> Tự động vào gamepass</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Subscription Confirmation Modal -->
        <div class="subscription-confirm-modal-overlay" id="subscription-confirm-modal" style="display: none;">
            <div class="subscription-confirm-modal-container">
                <div class="subscription-confirm-modal-header">
                    <h2><i class="fas fa-check-circle"></i> Xác Nhận Đăng Ký</h2>
                    <button class="subscription-confirm-modal-close" id="subscription-confirm-modal-close">&times;</button>
                </div>
                <div class="subscription-confirm-modal-content">
                    <div class="subscription-confirm-info" id="subscription-confirm-info">
                        <!-- Info will be inserted here -->
                    </div>
                    <div class="subscription-auto-payment">
                        <label class="checkbox-label">
                            <input type="checkbox" id="auto-payment-checkbox" checked>
                            <span>Tự động thanh toán hàng tháng</span>
                        </label>
                        <p class="auto-payment-note">Mỗi 30 ngày kể từ ngày đăng ký, nếu tài khoản có đủ tiền sẽ tự động trừ và tính tháng tiếp theo</p>
                    </div>
                    <div class="subscription-confirm-actions">
                        <button class="subscription-confirm-btn" id="subscription-confirm-btn" onclick="confirmSubscription()">
                            <i class="fas fa-check"></i> Xác Nhận Đăng Ký
                        </button>
                        <button class="subscription-cancel-btn" onclick="closeSubscriptionConfirmModal()">Hủy</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Admin Panel Modal -->
        <div class="admin-modal-overlay" id="admin-modal" style="display: none;">
            <div class="admin-modal-container">
                <div class="admin-modal-header">
                    <h2><i class="fas fa-shield-alt"></i> Admin Panel</h2>
                    <button class="admin-modal-close" id="admin-modal-close">&times;</button>
                </div>
                <div class="admin-modal-content">
                    <div class="admin-tabs">
                        <button class="admin-tab active" data-tab="orders">Đơn Hàng</button>
                        <button class="admin-tab" data-tab="transactions">Giao Dịch Nạp Tiền</button>
                        <button class="admin-tab" data-tab="users">Quản Lý Tiền</button>
                        <button class="admin-tab" data-tab="blacklist">Blacklist</button>
                    </div>
                    
                    <!-- Orders Tab -->
                    <div class="admin-tab-content active" id="admin-orders-tab">
                        <div class="admin-orders-list" id="admin-orders-list">
                            <!-- Orders will be loaded here -->
                        </div>
                    </div>
                    
                    <!-- Transactions Tab -->
                    <div class="admin-tab-content" id="admin-transactions-tab">
                        <div class="admin-transactions-list" id="admin-transactions-list">
                            <!-- Transactions will be loaded here -->
                        </div>
                    </div>
                    
                    <!-- Blacklist Tab -->
                    <div class="admin-tab-content" id="admin-blacklist-tab">
                        <div class="admin-add-money">
                            <h3>Quản Lý Blacklist</h3>
                            <div class="input-group">
                                <label>Email người dùng:</label>
                                <input type="email" id="blacklist-email" placeholder="user@example.com">
                            </div>
                            <button class="admin-btn" onclick="adminAddToBlacklist()">Thêm vào Blacklist</button>
                            <button class="admin-btn" style="background: #f44336; margin-top: 0.5rem;" onclick="adminRemoveFromBlacklist()">Gỡ khỏi Blacklist</button>
                        </div>
                        <div style="margin-top: 2rem;">
                            <h3 style="color: #333; margin-bottom: 1rem;">Danh sách Blacklist</h3>
                            <div id="blacklist-list" style="display: flex; flex-direction: column; gap: 0.5rem;">
                                <!-- Blacklist items will be loaded here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Users Tab -->
                    <div class="admin-tab-content" id="admin-users-tab">
                        <div class="admin-add-money">
                            <h3>Thêm Tiền Cho User</h3>
                            <input type="email" id="admin-user-email" placeholder="Email của user">
                            <input type="number" id="admin-amount" placeholder="Số tiền (VND)">
                            <button class="admin-btn" onclick="adminAddMoney()">Thêm Tiền</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="products-title" id="products" data-i18n="products.title">Sản Phẩm</div>
        
        <!-- Product Categories -->
        <div class="product-categories">
            <button class="category-btn active" data-category="all">Tất Cả</button>
            <button class="category-btn" data-category="robux">Robux</button>
            <button class="category-btn" data-category="account">Tài Khoản</button>
            <button class="category-btn" data-category="farming">Cày Thuê</button>
        </div>
        
        <section class="products-grid" id="products-grid">
            <!-- Products will be loaded dynamically -->
        </section>

        <div class="about-title" id="about" data-i18n="about.title">Về Cửa Hàng</div>
        <section class="about-section">
            <div class="about-card">
                <i class="fas fa-shield-alt"></i>
                <h3 data-i18n="about.quality">Chất Lượng Đảm Bảo</h3>
                <p data-i18n="about.qualityDesc">Tất cả script đều được kiểm tra kỹ lưỡng trước khi giao hàng</p>
            </div>
            <div class="about-card">
                <i class="fas fa-clock"></i>
                <h3 data-i18n="about.fast">Giao Hàng Nhanh</h3>
                <p data-i18n="about.fastDesc">Hoàn thành trong 24-48 giờ tùy theo độ phức tạp</p>
            </div>
            <div class="about-card">
                <i class="fas fa-headset"></i>
                <h3 data-i18n="about.support">Hỗ Trợ 24/7</h3>
                <p data-i18n="about.supportDesc">Đội ngũ hỗ trợ luôn sẵn sàng giải đáp thắc mắc</p>
            </div>
        </section>
    </main>

    <footer class="site-footer">
        <div class="footer-main">
            <div class="footer-content">
                <div class="footer-section">
                    <div class="footer-title" data-i18n="footer.aboutTitle">Về Chúng Tôi</div>
                    <div class="footer-desc" data-i18n="footer.aboutDesc">Cửa hàng chuyên cung cấp Robux và vật phẩm game Roblox với giá cả hợp lý.</div>
                    <div class="footer-location"><i class="fas fa-map-marker-alt"></i> <span data-i18n="footer.location">Hà Nội, Việt Nam</span></div>
                </div>
                <div class="footer-section">
                    <div class="footer-title" data-i18n="footer.contactTitle">Liên Hệ</div>
                    <div class="footer-contact">
                        <div><i class="fas fa-envelope"></i> <a href="mailto:dgkktok@gmail.com">dgkktok@gmail.com</a></div>
                        <div><i class="fab fa-facebook"></i> <a href="https://www.facebook.com/dreamisdreamforever" target="_blank" data-i18n="footer.facebook">Facebook</a></div>
                    </div>
                </div>
                <div class="footer-section">
                    <div class="footer-title" data-i18n="footer.linksTitle">Liên Kết</div>
                    <div class="footer-links">
                        <a href="index.html" data-i18n="footer.linkHome">Trang Chủ</a>
                        <a href="#products" data-i18n="footer.linkProducts">Sản Phẩm</a>
                        <a href="https://www.littlekhim.online/" target="_blank" data-i18n="footer.linkPortfolio">Portfolio</a>
                    </div>
                </div>
            </div>
            <div class="footer-bottom">
                <div class="footer-social-row">
                    <a href="https://x.com/dgkktok" target="_blank" title="Twitter"><i class="fab fa-twitter"></i></a>
                    <a href="https://www.facebook.com/dreamisdreamforever" target="_blank" title="Facebook"><i class="fab fa-facebook"></i></a>
                </div>
                <p>&copy; 2024 <span data-i18n="footer.copyright">Cửa Hàng Script Roblox. Tất cả quyền được bảo lưu.</span></p>
            </div>
        </div>
    </footer>

    <!-- Floating Navigation Buttons -->
    <div class="floating-nav-buttons">
        <a href="dev.html" class="floating-nav-btn dev-nav-btn" title="Đào Tạo">
            <i class="fas fa-graduation-cap"></i>
        </a>
        <a href="cheat.html" class="floating-nav-btn cheat-nav-btn" title="Cheat Code">
            <i class="fas fa-fire"></i>
        </a>
        <button class="floating-nav-btn cart-nav-btn" id="cart-icon" title="Giỏ Hàng">
            <i class="fas fa-shopping-cart"></i>
            <span class="floating-cart-count" id="cart-count">0</span>
        </button>
        <a href="https://www.littlekhim.online/" target="_blank" class="floating-nav-btn portfolio-nav-btn" title="Portfolio">
            <i class="fas fa-briefcase"></i>
        </a>
    </div>

    <script>
        // Cart functionality
        let cart = [];
        // Robux rate and stock
        const ROBUX_RATE = 125; // 1 Robux = 125 VND
        const ROBUX_STOCK = 10000; // 10k Robux available
        
        // MongoDB API endpoint (Vercel serverless function)
        // API Base URL - use relative path for same domain
        const API_BASE_URL = '/api'; // Vercel API routes
        
        const products = [
            {
                id: 'robux',
                category: 'robux',
                name: { vi: "Robux", en: "Robux" },
                description: { vi: `Mua Robux theo số lượng bạn muốn. Rate: ${ROBUX_RATE}₫/Robux`, en: `Buy Robux in any amount. Rate: ${ROBUX_RATE}₫/Robux` },
                price: 0,
                icon: "fas fa-coins",
                isCustomRobux: true,
                rate: ROBUX_RATE,
                stock: ROBUX_STOCK,
                stockDisplay: true
            },
            {
                id: 'account',
                category: 'account',
                name: { vi: "Tài Khoản", en: "Account" },
                description: { vi: "Tài khoản Roblox với các vật phẩm độc đáo", en: "Roblox accounts with unique items" },
                price: 0,
                icon: "fas fa-user",
                stock: 0,
                stockDisplay: true
            },
            {
                id: 'farming',
                category: 'farming',
                name: { vi: "Cày Thuê", en: "Farming Service" },
                description: { vi: "Dịch vụ cày thuê game Roblox theo yêu cầu", en: "Roblox farming service on demand" },
                price: 0,
                icon: "fas fa-tractor",
                stock: 0,
                stockDisplay: true
            },
            {
                id: 'auto-robux',
                category: 'robux',
                name: { vi: "Robux Tự Động", en: "Auto Robux" },
                description: { vi: "Dịch vụ cung cấp Robux tự động mỗi ngày vào gamepass của bạn", en: "Automatic Robux service delivered daily to your gamepass" },
                price: 0,
                icon: "fas fa-sync-alt",
                isAutoRobux: true,
                stockDisplay: false
            }
        ];
        
        // Discord webhook URL - Replace with your actual webhook URL
        const DISCORD_WEBHOOK_URL = 'YOUR_DISCORD_WEBHOOK_URL_HERE';
        
        // User management
        let currentUser = null;
        let userBalance = 0;
        
        // Appwrite references (initialized in module script above)
        let client, account;
        let buttonsRendered = false; // Flag to prevent multiple renders
        
        function initializeAppwrite() {
            // Check if Appwrite SDK is loaded
            if (!window.appwriteSDKLoaded || !window.AppwriteSDK) {
                return false;
            }
            
            // Use the pre-initialized client and account from the module
            client = window.AppwriteSDK.client;
            account = window.AppwriteSDK.account;
            
            if (!client || !account) {
                console.warn('Appwrite client or account not available');
                return false;
            }
            
            console.log('Appwrite initialized successfully');
            return true;
        }
        
        // Bank info for top-up (replace with your actual info)
        const BANK_INFO = {
            bankName: 'MBBANK',
            accountNumber: '866613102008',
            accountName: 'DUONG GIA KHIEM',
            // Get direct image link from ImgBB: Right-click image on https://ibb.co/YFSCMw0J and "Copy image address"
            qrCodeUrl: 'https://i.ibb.co/YFSCMw0J/qr-code.jpg' // Update with direct link from ImgBB if this doesn't work
        };
        
        // Admin configuration
        const ADMIN_EMAIL = 'dgkktok@gmail.com'; // Admin email - only this user can access admin panel
        const Test = '';
        // Store orders for admin management
        let allOrders = JSON.parse(localStorage.getItem('store_orders') || '[]');
        
        // Check if current user is admin
        function isAdmin() {
            if (!currentUser || !currentUser.email) {
                console.log('isAdmin: No current user or email');
                return false;
            }
            
            const userEmail = currentUser.email.toLowerCase().trim();
            const adminEmail = ADMIN_EMAIL.toLowerCase().trim();
            
            console.log('isAdmin check:', {
                userEmail: userEmail,
                adminEmail: adminEmail,
                match: userEmail === adminEmail
            });
            
            // Check both exact match and case-insensitive
            return userEmail === adminEmail;
        }
        
        // Check if user has pending transaction
        function hasPendingTransaction() {
            if (!currentUser) return false;
            const userTransactions = JSON.parse(localStorage.getItem(`store_transactions_${currentUser.email}`) || '[]');
            return userTransactions.some(txn => txn.status === 'pending');
        }
        
        // Notification System
        function showNotification(title, message, type = 'info', options = {}) {
            const overlay = document.getElementById('notification-overlay');
            const content = document.getElementById('notification-content');
            const actions = document.getElementById('notification-actions');
            
            // Set notification type styling
            const typeConfig = {
                'info': { icon: 'fa-info-circle', color: '#4caf50' },
                'warning': { icon: 'fa-exclamation-triangle', color: '#ff9800' },
                'error': { icon: 'fa-times-circle', color: '#f44336' },
                'success': { icon: 'fa-check-circle', color: '#4caf50' }
            };
            
            const config = typeConfig[type] || typeConfig.info;
            
            content.innerHTML = `
                <div class="notification-title">
                    <i class="fas ${config.icon}" style="color: ${config.color};"></i>
                    <span>${title}</span>
                </div>
                <div class="notification-message">${message}</div>
            `;
            
            // Add action buttons if provided
            if (options.buttons && options.buttons.length > 0) {
                actions.innerHTML = options.buttons.map(btn => 
                    `<button class="notification-btn ${btn.class || ''}" onclick="${btn.onclick || 'closeNotification()'}">${btn.text}</button>`
                ).join('');
            } else {
                actions.innerHTML = '<button class="notification-btn notification-btn-primary" onclick="closeNotification()">Đóng</button>';
            }
            
            overlay.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            
            // Auto close if timeout provided
            if (options.timeout) {
                setTimeout(() => {
                    closeNotification();
                }, options.timeout);
            }
        }
        
        function closeNotification() {
            document.getElementById('notification-overlay').style.display = 'none';
            document.body.style.overflow = '';
        }

        let currentLanguage = 'vi';
        const exchangeRate = 24000;

        const translations = {
            vi: {
                'nav.home': 'Trang Chủ',
                'nav.products': 'Sản Phẩm',
                'nav.about': 'Về Chúng Tôi',
                'nav.portfolio': 'Portfolio',
                'nav.dev': 'Đào Tạo',
                'nav.cheat': 'Cheat Code',
                'store.title': 'Cửa Hàng Roblox',
                'store.subtitle': 'Mua Robux, Vật Phẩm Game với giá tốt nhất',
                'products.title': 'Sản Phẩm',
                'about.title': 'Về Cửa Hàng',
                'about.quality': 'Chất Lượng Đảm Bảo',
                'about.qualityDesc': 'Tất cả Robux và vật phẩm đều được kiểm tra kỹ lưỡng trước khi giao hàng',
                'about.fast': 'Giao Hàng Nhanh',
                'about.fastDesc': 'Giao hàng nhanh chóng trong vòng 5-15 phút',
                'about.support': 'Hỗ Trợ 24/7',
                'about.supportDesc': 'Đội ngũ hỗ trợ luôn sẵn sàng giải đáp thắc mắc',
                'cart.title': 'Giỏ Hàng',
                'cart.empty': 'Giỏ hàng trống',
                'cart.total': 'Tổng cộng:',
                'cart.checkout': 'Thanh Toán',
                'order.title': 'Đặt Hàng',
                'order.total': 'Tổng cộng:',
                'order.codeLabel': 'Mã Đơn Hàng:',
                'order.contactFacebook': 'Nhắn tin Facebook với mã đơn hàng',
                'cart.remove': 'Xóa',
                'cart.add': 'Thêm vào giỏ',
                'footer.aboutTitle': 'Về Chúng Tôi',
                'footer.aboutDesc': 'Cửa hàng chuyên cung cấp Robux và vật phẩm game Roblox với giá cả hợp lý.',
                'footer.location': 'Hà Nội, Việt Nam',
                'footer.contactTitle': 'Liên Hệ',
                'footer.facebook': 'Facebook',
                'footer.linksTitle': 'Liên Kết',
                'footer.linkHome': 'Trang Chủ',
                'footer.linkProducts': 'Sản Phẩm',
                'footer.linkPortfolio': 'Portfolio',
                'footer.copyright': 'Cửa Hàng Roblox. Tất cả quyền được bảo lưu.'
            },
            en: {
                'nav.home': 'Home',
                'nav.products': 'Products',
                'nav.about': 'About',
                'nav.portfolio': 'Portfolio',
                'nav.dev': 'Training',
                'nav.cheat': 'Cheat Code',
                'store.title': 'Roblox Script Store',
                'store.subtitle': 'Buy Script, Fix Script, Create Script on demand',
                'products.title': 'Products',
                'about.title': 'About Store',
                'about.quality': 'Quality Guaranteed',
                'about.qualityDesc': 'All scripts are thoroughly tested before delivery',
                'about.fast': 'Fast Delivery',
                'about.fastDesc': 'Completed within 24-48 hours depending on complexity',
                'about.support': '24/7 Support',
                'about.supportDesc': 'Support team is always ready to answer questions',
                'cart.title': 'Shopping Cart',
                'cart.empty': 'Cart is empty',
                'cart.total': 'Total:',
                'cart.checkout': 'Checkout',
                'order.title': 'Place Order',
                'order.total': 'Total:',
                'order.codeLabel': 'Order Code:',
                'order.contactFacebook': 'Message Facebook with order code',
                'cart.remove': 'Remove',
                'cart.add': 'Add to Cart',
                'footer.aboutTitle': 'About Us',
                'footer.aboutDesc': 'Store specializing in high-quality Roblox Script services at reasonable prices.',
                'footer.location': 'Hanoi, Vietnam',
                'footer.contactTitle': 'Contact',
                'footer.facebook': 'Facebook',
                'footer.linksTitle': 'Links',
                'footer.linkHome': 'Home',
                'footer.linkProducts': 'Products',
                'footer.linkPortfolio': 'Portfolio',
                'footer.copyright': 'Roblox Script Store. All rights reserved.'
            }
        };

        function applyTranslations() {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.dataset.i18n;
                const translated = translations[currentLanguage]?.[key];
                if (translated !== undefined) {
                    el.textContent = translated;
                }
            });
        }

        function formatCurrency(amount) {
            if (currentLanguage === 'en') {
                return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount / exchangeRate);
            }
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
        }

        let currentCategory = 'all';
        
        // Load stock from MongoDB
        async function loadStockFromDB() {
            // Skip if API URL is not configured
            if (!API_BASE_URL || API_BASE_URL.includes('your-vercel-app')) {
                console.log('API not configured, using default stock values');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/stock`);
                if (response.ok) {
                    const data = await response.json();
                    // Update products stock from database
                    products.forEach(product => {
                        if (data[product.id]) {
                            product.stock = data[product.id].stock || product.stock;
                        }
                    });
                }
            } catch (error) {
                console.log('Failed to load stock from DB, using default values:', error);
            }
        }
        
        // Save user data to MongoDB
        async function saveUserToDB(userData) {
            try {
                await fetch(`${API_BASE_URL}/users`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(userData)
                });
            } catch (error) {
                console.error('Failed to save user:', error);
            }
        }
        
        function renderProducts(category = 'all') {
            const productsGrid = document.getElementById('products-grid');
            const filteredProducts = category === 'all' 
                ? products 
                : products.filter(p => p.category === category);
            
            if (filteredProducts.length === 0) {
                productsGrid.innerHTML = '<p class="no-products">Không có sản phẩm nào</p>';
                return;
            }
            
            productsGrid.innerHTML = filteredProducts.map(product => {
                const name = product.name[currentLanguage] || product.name.vi;
                const description = product.description[currentLanguage] || product.description.vi;
                
                if (product.isCustomRobux) {
                    const stockText = product.stock > 0 ? product.stock.toLocaleString() : 'Hết hàng';
                    return `
                        <div class="product-card robux-custom-card clickable-card" data-category="${product.category}" onclick="openRobuxModal()">
                            <div class="product-header">
                                <div class="product-icon">
                                    <i class="${product.icon}"></i>
                                </div>
                                <h3 class="product-name">${name}</h3>
                            </div>
                            <div class="product-content">
                                <p class="product-description">${description}</p>
                                <div class="product-info-row">
                                    <span class="product-rate">Rate: ${product.rate}₫</span>
                                </div>
                                <div class="product-stock-row">
                                    <span class="product-stock">Còn lại: ${stockText}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                if (product.isAutoRobux) {
                    return `
                        <div class="product-card auto-robux-card clickable-card" data-category="${product.category}" onclick="openAutoRobuxModal()">
                            <div class="product-header">
                                <div class="product-icon">
                                    <i class="${product.icon}"></i>
                                </div>
                                <h3 class="product-name">${name}</h3>
                            </div>
                            <div class="product-content">
                                <p class="product-description">${description}</p>
                                <div class="product-info-row">
                                    <span class="product-badge"><i class="fas fa-check-circle"></i> Cung cấp mỗi ngày</span>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                const stockText = product.stockDisplay && product.stock !== undefined 
                    ? (product.stock > 0 ? product.stock.toLocaleString() : 'Hết hàng')
                    : '';
                
                return `
                    <div class="product-card clickable-card" data-category="${product.category}" onclick="openProductModal('${product.id}')">
                        <div class="product-header">
                            <div class="product-icon">
                                <i class="${product.icon}"></i>
                            </div>
                            <h3 class="product-name">${name}</h3>
                        </div>
                        <div class="product-content">
                            <p class="product-description">${description}</p>
                            ${stockText ? `<div class="product-stock-row"><span class="product-stock">Còn lại: ${stockText}</span></div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            applyTranslations();
        }
        
        function openRobuxModal() {
            checkLoginBeforeAction(() => {
                // Check for pending transactions
                if (hasPendingTransaction()) {
                    showNotification(
                        'Giao dịch đang chờ xử lý',
                        'Bạn có giao dịch nạp tiền đang chờ xử lý. Vui lòng đợi giao dịch được xác nhận hoặc hủy trước khi mua Robux.',
                        'warning',
                        {
                            buttons: [
                                { text: 'Xem lịch sử', onclick: 'closeNotification(); openTransactionHistory();', class: 'notification-btn-primary' },
                                { text: 'Đóng', onclick: 'closeNotification()', class: '' }
                            ]
                        }
                    );
                    return;
                }
                
                // Get current user balance from server
                getCurrentBalance().then(currentBalance => {
                    const maxAffordable = Math.floor(currentBalance / ROBUX_RATE);
                    
                    showRobuxPurchaseModal(currentBalance, maxAffordable);
                }).catch(error => {
                    console.error('Error getting balance:', error);
                    // Fallback to local balance
                    const currentBalance = userBalance;
                    const maxAffordable = Math.floor(currentBalance / ROBUX_RATE);
                    showRobuxPurchaseModal(currentBalance, maxAffordable);
                });
            });
        }
        
        function showRobuxPurchaseModal(currentBalance, maxAffordable) {
            const content = `
                <div class="robux-purchase-form">
                    <div class="balance-info">
                        <div class="balance-item">
                            <i class="fas fa-wallet"></i>
                            <div>
                                <div class="balance-label">Số tiền hiện tại</div>
                                <div class="balance-value">${formatCurrency(currentBalance)}</div>
                            </div>
                        </div>
                        ${maxAffordable > 0 ? `
                            <div class="balance-item">
                                <i class="fas fa-chart-bar"></i>
                                <div>
                                    <div class="balance-label">Có thể mua tối đa</div>
                                    <div class="balance-value">${maxAffordable.toLocaleString()} Robux</div>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    <div class="input-group">
                        <label>Số lượng Robux (1-${ROBUX_STOCK.toLocaleString()}):</label>
                        <input type="number" id="robux-quantity-input" min="1" max="${ROBUX_STOCK}" value="1" oninput="updateRobuxPurchasePreview()">
                    </div>
                    <div class="purchase-preview" id="robux-purchase-preview">
                        <div class="preview-item">
                            <span>Số lượng:</span>
                            <strong id="preview-quantity">1</strong> Robux
                        </div>
                        <div class="preview-item">
                            <span>Giá tiền:</span>
                            <strong id="preview-price">${formatCurrency(ROBUX_RATE)}</strong>
                        </div>
                        <div class="preview-item total">
                            <span>Số dư sau khi mua:</span>
                            <strong id="preview-balance">${formatCurrency(currentBalance - ROBUX_RATE)}</strong>
                        </div>
                    </div>
                </div>
            `;
            
            showNotification(
                'Mua Robux',
                content,
                'info',
                {
                    buttons: [
                        { 
                            text: 'Xác nhận mua', 
                            onclick: `confirmRobuxPurchase(${currentBalance})`, 
                            class: 'notification-btn-primary' 
                        },
                        { text: 'Hủy', onclick: 'closeNotification()', class: '' }
                    ]
                }
            );
            
            // Store current balance for preview
            window.currentBalanceForPreview = currentBalance;
            
            // Update preview on input
            document.getElementById('robux-quantity-input').addEventListener('input', updateRobuxPurchasePreview);
        }
        
        function updateRobuxPurchasePreview() {
            const input = document.getElementById('robux-quantity-input');
            if (!input) return;
            
            const quantity = parseInt(input.value) || 1;
            const price = quantity * ROBUX_RATE;
            const currentBalance = window.currentBalanceForPreview || userBalance;
            const newBalance = currentBalance - price;
            
            document.getElementById('preview-quantity').textContent = quantity.toLocaleString();
            document.getElementById('preview-price').textContent = formatCurrency(price);
            document.getElementById('preview-balance').textContent = formatCurrency(Math.max(0, newBalance));
            
            // Highlight if insufficient balance
            const previewBalance = document.getElementById('preview-balance');
            if (newBalance < 0) {
                previewBalance.style.color = '#f44336';
            } else {
                previewBalance.style.color = '#4caf50';
            }
        }
        
        async function confirmRobuxPurchase(currentBalance) {
            const input = document.getElementById('robux-quantity-input');
            if (!input) {
                closeNotification();
                return;
            }
            
            const quantity = parseInt(input.value) || 0;
            
            if (quantity <= 0) {
                closeNotification();
                showNotification('Lỗi', 'Vui lòng nhập số lượng hợp lệ!', 'error');
                return;
            }
            
            if (quantity > ROBUX_STOCK) {
                closeNotification();
                showNotification(
                    'Lỗi',
                    `Số lượng vượt quá stock hiện có!\n\nStock còn lại: ${ROBUX_STOCK.toLocaleString()} Robux`,
                    'error'
                );
                return;
            }
            
            const price = quantity * ROBUX_RATE;
            
            // Get latest balance from server before checking
            let latestBalance = currentBalance;
            try {
                latestBalance = await getCurrentBalance();
                console.log('Latest balance before purchase:', latestBalance);
            } catch (error) {
                console.error('Error getting latest balance:', error);
            }
            
            if (price > latestBalance) {
                const shortage = price - latestBalance;
                closeNotification();
                showNotification(
                    'Số tiền không đủ',
                    `Số tiền hiện có: ${formatCurrency(latestBalance)}\n` +
                    `Số tiền cần: ${formatCurrency(price)}\n` +
                    `Thiếu: ${formatCurrency(shortage)}\n\n` +
                    `Vui lòng nạp thêm tiền để tiếp tục.`,
                    'error',
                    {
                        buttons: [
                            { text: 'Nạp tiền', onclick: 'closeNotification(); openTopUpModal();', class: 'notification-btn-primary' },
                            { text: 'Đóng', onclick: 'closeNotification()', class: '' }
                        ]
                    }
                );
                return;
            }
            
            closeNotification();
            addRobuxToCartDirect(quantity, price);
            showNotification(
                'Thành công',
                `Đã thêm ${quantity.toLocaleString()} Robux vào giỏ hàng!\n\nGiá: ${formatCurrency(price)}`,
                'success',
                { timeout: 2000 }
            );
        }
        
        // Get balance from server (to prevent F12 manipulation)
        async function getCurrentBalance() {
            if (!currentUser || !currentUser.email) {
                console.warn('getCurrentBalance: No current user');
                return userBalance || 0;
            }
            
            try {
                const email = encodeURIComponent(currentUser.email);
                const url = `${API_BASE_URL}/users/balance?email=${email}`;
                console.log('Fetching balance from server:', url);
                const response = await fetch(url);
                
                if (response.ok) {
                    const data = await response.json();
                    const serverBalance = data.balance || 0;
                    console.log('Balance from server:', serverBalance);
                    
                    // Update local balance
                    userBalance = serverBalance;
                    saveUserData();
                    
                    // Update UI
                    const balanceEl = document.getElementById('user-balance');
                    if (balanceEl) {
                        balanceEl.textContent = formatCurrency(userBalance);
                    }
                    
                    return userBalance;
                } else {
                    console.warn('Failed to fetch balance, status:', response.status);
                    const errorText = await response.text();
                    console.warn('Error response:', errorText);
                }
            } catch (error) {
                console.error('Error fetching balance from server:', error);
            }
            
            // Fallback to local balance
            console.log('Using fallback balance from localStorage:', userBalance);
            return userBalance || 0;
        }
        
        // Update balance on server
        async function updateBalanceOnServer(newBalance) {
            if (!currentUser || !currentUser.email) return;
            
            try {
                const email = encodeURIComponent(currentUser.email);
                const url = `${API_BASE_URL}/users/balance?email=${email}`;
                
                console.log('Updating balance on server:', url, 'New balance:', newBalance);
                
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ balance: newBalance })
                });
                
                if (response.ok) {
                    console.log('✅ Balance updated successfully on server');
                } else {
                    const errorText = await response.text();
                    console.error('❌ Failed to update balance:', response.status, errorText);
                }
            } catch (error) {
                console.error('Error updating balance on server:', error);
            }
        }
        
        function openProductModal(productId) {
            checkLoginBeforeAction(() => {
                alert('Tính năng đang được phát triển. Vui lòng liên hệ qua Facebook để đặt hàng.');
            });
        }
        
        function addRobuxToCartDirect(robuxAmount, price) {
            // Check balance from server before adding to cart
            getCurrentBalance().then(currentBalance => {
                if (price > currentBalance) {
                    showNotification(
                        'Số tiền không đủ',
                        `Số tiền hiện có: ${formatCurrency(currentBalance)}\n` +
                        `Số tiền cần: ${formatCurrency(price)}\n` +
                        `Thiếu: ${formatCurrency(price - currentBalance)}`,
                        'error'
                    );
                    return;
                }
                
            const robuxProduct = products.find(p => p.id === 'robux');
            cart.push({
                id: 'robux-' + Date.now(),
                name: robuxProduct.name,
                price: price,
                quantity: 1,
                robuxAmount: robuxAmount,
                isCustomRobux: true
            });
            updateCart();
            }).catch(error => {
                console.error('Error checking balance:', error);
                // Fallback: add to cart anyway
                const robuxProduct = products.find(p => p.id === 'robux');
                cart.push({
                    id: 'robux-' + Date.now(),
                    name: robuxProduct.name,
                    price: price,
                    quantity: 1,
                    robuxAmount: robuxAmount,
                    isCustomRobux: true
                });
                updateCart();
            });
        }
        
        function updateRobuxPrice(productId) {
            const product = products.find(p => p.id === productId);
            if (!product || !product.isCustomRobux) return;
            
            const input = document.getElementById(`robux-quantity-${productId}`);
            const priceDisplay = document.getElementById(`robux-price-${productId}`);
            let quantity = parseInt(input.value) || 0;
            
            if (quantity > product.stock) {
                input.value = product.stock;
                quantity = product.stock;
            }
            
            if (quantity < 1) {
                input.value = 1;
                quantity = 1;
            }
            
            const totalPrice = quantity * product.rate;
            priceDisplay.textContent = formatCurrency(totalPrice);
        }
        
        function addRobuxToCart(productId) {
            checkLoginBeforeAction(() => {
                const product = products.find(p => p.id === productId);
                if (!product || !product.isCustomRobux) return;
                
                const input = document.getElementById(`robux-quantity-${productId}`);
                const quantity = parseInt(input.value) || 0;
                
                if (quantity < 1) {
                    alert(currentLanguage === 'vi' ? 'Vui lòng nhập số lượng Robux hợp lệ!' : 'Please enter a valid Robux amount!');
                    return;
                }
                
                if (quantity > product.stock) {
                    alert(currentLanguage === 'vi' ? `Số lượng vượt quá stock hiện có (${product.stock.toLocaleString()} Robux)!` : `Amount exceeds available stock (${product.stock.toLocaleString()} Robux)!`);
                    return;
                }
                
                const price = quantity * product.rate;
                const cartItem = {
                    ...product,
                    quantity: quantity,
                    price: price,
                    robuxAmount: quantity
                };
                
                // Check if custom Robux already in cart
                const existingIndex = cart.findIndex(item => item.id === productId);
                if (existingIndex >= 0) {
                    cart[existingIndex] = cartItem; // Replace with new quantity
                } else {
                    cart.push(cartItem);
                }
                
                updateCart();
            });
        }

        function addToCart(productId) {
            checkLoginBeforeAction(() => {
                const product = products.find(p => p.id === productId);
                if (product) {
                    // Skip if it's custom Robux (use addRobuxToCart instead)
                    if (product.isCustomRobux) {
                        addRobuxToCart(productId);
                        return;
                    }
                    
                    const existingItem = cart.find(item => item.id === productId);
                    if (existingItem) {
                        existingItem.quantity += 1;
                    } else {
                        cart.push({ ...product, quantity: 1 });
                    }
                    updateCart();
                }
            });
        }

        function removeFromCart(productId) {
            cart = cart.filter(item => item.id !== productId);
            updateCart();
        }

        function updateCart() {
            const cartCount = document.getElementById('cart-count');
            const cartItems = document.getElementById('cart-items');
            const cartTotalPrice = document.getElementById('cart-total-price');

            cartCount.textContent = cart.reduce((sum, item) => sum + item.quantity, 0);

            if (cart.length === 0) {
                cartItems.innerHTML = `<p class="cart-empty" data-i18n="cart.empty">Giỏ hàng trống</p>`;
            } else {
                cartItems.innerHTML = cart.map(item => {
                    const name = item.name[currentLanguage] || item.name.vi;
                    const displayName = item.isCustomRobux && item.robuxAmount 
                        ? `${name} (${item.robuxAmount.toLocaleString()} Robux)`
                        : name;
                    return `
                        <div class="cart-item">
                            <div class="cart-item-info">
                                <h4>${displayName}</h4>
                                <p>${formatCurrency(item.price)}${item.quantity > 1 ? ` x ${item.quantity}` : ''}</p>
                            </div>
                            <div class="cart-item-actions">
                                <button class="cart-remove-btn" onclick="removeFromCart(${typeof item.id === 'string' ? `'${item.id}'` : item.id})" data-i18n="cart.remove">Xóa</button>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            cartTotalPrice.textContent = formatCurrency(total);
            applyTranslations();
        }

        function openCart() {
            document.getElementById('cart-sidebar').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeCart() {
            document.getElementById('cart-sidebar').classList.remove('active');
            document.body.style.overflow = '';
        }

        function generateOrderCode() {
            const timestamp = Date.now();
            const random = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
            return `ORD-${timestamp}-${random}`;
        }

        function openOrderModal() {
            if (cart.length === 0) {
                alert(currentLanguage === 'vi' ? 'Giỏ hàng trống!' : 'Cart is empty!');
                return;
            }
            
            const orderModal = document.getElementById('order-modal');
            const orderCode = generateOrderCode();
            const orderCodeInput = document.getElementById('order-code-input');
            const orderItemsList = document.getElementById('order-items-list');
            const orderTotalPrice = document.getElementById('order-total-price');
            
            // Set order code
            orderCodeInput.value = orderCode;
            
            // Display order items
            const itemsHtml = cart.map(item => {
                const name = item.name[currentLanguage] || item.name.vi;
                const displayName = item.isCustomRobux && item.robuxAmount 
                    ? `${name} (${item.robuxAmount.toLocaleString()} Robux)`
                    : name;
                const itemTotal = item.price * item.quantity;
                return `
                    <div class="order-item-row">
                        <span class="order-item-name">${displayName} x${item.quantity}</span>
                        <span class="order-item-price">${formatCurrency(itemTotal)}</span>
                    </div>
                `;
            }).join('');
            orderItemsList.innerHTML = itemsHtml;
            
            // Calculate and display total
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            orderTotalPrice.textContent = formatCurrency(total);
            
            // Update Facebook link with order code
            const facebookBtn = document.getElementById('facebook-order-btn');
            const facebookLink = 'https://m.me/dreamisdreamforever';
            const message = encodeURIComponent(`Xin chào! Tôi muốn đặt hàng với mã đơn hàng: ${orderCode}`);
            facebookBtn.href = `${facebookLink}?text=${message}`;
            
            // Process order (check balance and deduct)
            processOrder(orderCode, cart, total);
        }
        
        async function processOrder(orderCode, cartItems, total) {
            try {
                // Check balance from server
                const currentBalance = await getCurrentBalance();
                
                if (total > currentBalance) {
                    showNotification(
                        'Số tiền không đủ',
                        `Số tiền hiện có: ${formatCurrency(currentBalance)}\n` +
                        `Tổng đơn hàng: ${formatCurrency(total)}\n` +
                        `Thiếu: ${formatCurrency(total - currentBalance)}`,
                        'error'
                    );
                    return;
                }
                
                // Deduct balance from server
                const newBalance = currentBalance - total;
                await updateBalanceOnServer(newBalance);
                
                // Update local balance
                userBalance = newBalance;
                saveUserData();
                document.getElementById('user-balance').textContent = formatCurrency(userBalance);
                
                // Save order to allOrders for admin management
                const orderData = {
                    code: orderCode,
                    userEmail: currentUser.email,
                    userName: currentUser.name,
                    items: cartItems.map(item => ({
                        name: item.name[currentLanguage] || item.name.vi,
                        price: item.price,
                        quantity: item.quantity,
                        robuxAmount: item.robuxAmount || null
                    })),
                    total: total,
                    status: 'pending',
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                allOrders.push(orderData);
                localStorage.setItem('store_orders', JSON.stringify(allOrders));
                
                // Save order to server
                await saveOrderToServer(orderData);
            
            // Send Discord webhook
                sendDiscordWebhook(orderCode, cartItems, total);
                
                // Clear cart
                cart = [];
                updateCart();
                
                // Show order modal
                const orderModal = document.getElementById('order-modal');
            orderModal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
                
            } catch (error) {
                console.error('Error processing order:', error);
                showNotification('Lỗi', 'Không thể xử lý đơn hàng. Vui lòng thử lại!', 'error');
            }
        }
        
        // Save order to server
        async function saveOrderToServer(orderData) {
            try {
                await fetch(`${API_BASE_URL}/orders`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderData)
                });
            } catch (error) {
                console.error('Error saving order to server:', error);
            }
        }
        
        async function sendDiscordWebhook(orderCode, cartItems, total) {
            if (!DISCORD_WEBHOOK_URL || DISCORD_WEBHOOK_URL === 'YOUR_DISCORD_WEBHOOK_URL_HERE') {
                console.warn('Discord webhook URL not configured');
                return;
            }
            
            const itemsList = cartItems.map(item => {
                const name = item.name[currentLanguage] || item.name.vi;
                const displayName = item.isCustomRobux && item.robuxAmount 
                    ? `${name} (${item.robuxAmount.toLocaleString()} Robux)`
                    : name;
                return `- ${displayName} x${item.quantity} - ${formatCurrency(item.price * item.quantity)}`;
            }).join('\n');
            
            const embed = {
                title: '🛒 Đơn Hàng Mới',
                description: `Mã đơn hàng: **${orderCode}**`,
                color: 0x4caf50,
                fields: [
                    {
                        name: '📦 Sản Phẩm',
                        value: itemsList || 'Không có sản phẩm',
                        inline: false
                    },
                    {
                        name: '💰 Tổng Tiền',
                        value: formatCurrency(total),
                        inline: true
                    },
                    {
                        name: '🕐 Thời Gian',
                        value: new Date().toLocaleString('vi-VN'),
                        inline: true
                    }
                ],
                timestamp: new Date().toISOString()
            };
            
            try {
                await fetch(DISCORD_WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        embeds: [embed]
                    })
                });
            } catch (error) {
                console.error('Failed to send Discord webhook:', error);
            }
        }

        function closeOrderModal() {
            const orderModal = document.getElementById('order-modal');
            orderModal.style.display = 'none';
            document.body.style.overflow = '';
        }


        function checkout() {
            openOrderModal();
        }
        
        // User management functions
        async function loadUserData() {
            // First check Appwrite session
            await checkUserSession();
            
            // If no Appwrite session, check localStorage
            if (!currentUser) {
            const savedUser = localStorage.getItem('store_user');
            const savedBalance = localStorage.getItem('store_balance');
            
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                userBalance = savedBalance ? parseFloat(savedBalance) : 0;
                    
                    // Try to load balance from server
                    getCurrentBalance().then(balance => {
                        console.log('Balance loaded after localStorage check:', balance);
                showUserMenu();
                    }).catch(error => {
                        console.error('Error loading balance:', error);
                        showUserMenu();
                    });
            } else {
                showLoginButton();
                }
            }
            
            // Handle OAuth callback if present
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('error') === 'auth_failed') {
                alert('Đăng nhập thất bại. Vui lòng thử lại.');
                // Clean URL
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }
        
        function saveUserData() {
            if (currentUser) {
                localStorage.setItem('store_user', JSON.stringify(currentUser));
                localStorage.setItem('store_balance', userBalance.toString());
                
                // Also save to MongoDB
                saveUserToDB({
                    email: currentUser.email,
                    name: currentUser.name,
                    balance: userBalance
                });
            }
        }
        
        // Save user to MongoDB
        async function saveUserToDB(userData) {
            try {
                await fetch(`${API_BASE_URL}/users`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(userData)
                });
            } catch (error) {
                console.error('Failed to save user to DB:', error);
            }
        }
        
        function showUserMenu() {
            const userMenuContainer = document.getElementById('user-menu-container');
            const signinContainer = document.getElementById('google-signin-container');
            const adminBtn = document.getElementById('admin-panel-btn');
            
            if (userMenuContainer) userMenuContainer.style.display = 'block';
            if (signinContainer) signinContainer.style.display = 'none';
            
            const userNameEl = document.getElementById('user-name');
            const userBalanceEl = document.getElementById('user-balance');
            if (userNameEl) userNameEl.textContent = currentUser.name || currentUser.email;
            if (userBalanceEl) userBalanceEl.textContent = formatCurrency(userBalance);
            
            // Show admin button if user is admin
            if (adminBtn) {
                const adminStatus = isAdmin();
                console.log('showUserMenu - Admin status:', adminStatus, 'Current user:', currentUser);
                
                if (adminStatus) {
                    adminBtn.style.display = 'block';
                    adminBtn.removeAttribute('style'); // Remove inline style
                    adminBtn.style.display = 'block'; // Set to block
                    console.log('✅ Admin panel button is now visible');
                } else {
                    adminBtn.style.display = 'none';
                    console.log('❌ User is not admin, hiding admin panel button');
                }
            } else {
                console.error('Admin panel button not found in DOM!');
            }
        }
        
        function showLoginButton() {
            const userMenuContainer = document.getElementById('user-menu-container');
            const signinContainer = document.getElementById('google-signin-container');
            
            if (userMenuContainer) userMenuContainer.style.display = 'none';
            if (signinContainer) {
                signinContainer.style.display = 'flex'; // Use flex to match CSS
                // Ensure button is rendered (only if not already rendered)
                if (!buttonsRendered) {
            initializeGoogleSignIn();
                }
            }
        }
        
        async function logout() {
            try {
                if (account) {
                    await account.deleteSession('current');
                }
            } catch (error) {
                console.error('Error logging out from Appwrite:', error);
            }
            currentUser = null;
            userBalance = 0;
            localStorage.removeItem('store_user');
            localStorage.removeItem('store_balance');
            showLoginButton();
        }
        
        function generateRandomCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 9; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }
        
        function openTopUpModal() {
            // Check for pending transactions
            if (hasPendingTransaction()) {
                showNotification(
                    'Giao dịch đang chờ xử lý',
                    'Bạn có giao dịch nạp tiền đang chờ xử lý. Vui lòng đợi giao dịch được xác nhận hoặc hủy trước khi tạo giao dịch mới.',
                    'warning',
                    {
                        buttons: [
                            { text: 'Xem lịch sử', onclick: 'closeNotification(); openTransactionHistory();', class: 'notification-btn-primary' },
                            { text: 'Đóng', onclick: 'closeNotification()', class: '' }
                        ]
                    }
                );
                return;
            }
            
            const modal = document.getElementById('topup-modal');
            const randomCode = generateRandomCode();
            
            document.getElementById('topup-bank-name').textContent = BANK_INFO.bankName;
            document.getElementById('topup-account-number').textContent = BANK_INFO.accountNumber;
            document.getElementById('topup-account-name').textContent = BANK_INFO.accountName;
            document.getElementById('topup-random-code').textContent = randomCode;
            document.getElementById('topup-note-code').textContent = randomCode;
            
            // Update QR code (you can replace this with actual QR code generation)
            const qrContainer = document.querySelector('.topup-qr-placeholder');
            qrContainer.innerHTML = `
                <img src="${BANK_INFO.qrCodeUrl}" alt="QR Code" style="max-width: 300px; height: auto; border-radius: 0.5rem;">
                <p class="topup-note">Vui lòng quét QR để chuyển khoản</p>
            `;
            
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }
        
        function closeTopUpModal() {
            document.getElementById('topup-modal').style.display = 'none';
            document.body.style.overflow = '';
        }
        
        function confirmTopUp() {
            const amount = parseFloat(document.getElementById('topup-amount').value);
            if (amount < 10000) {
                showNotification('Lỗi', 'Số tiền tối thiểu là 10,000₫', 'error');
                return;
            }
            
            // Check for pending transactions again
            if (hasPendingTransaction()) {
                showNotification(
                    'Giao dịch đang chờ xử lý',
                    'Bạn có giao dịch nạp tiền đang chờ xử lý. Vui lòng đợi giao dịch được xác nhận hoặc hủy trước khi tạo giao dịch mới.',
                    'warning',
                    {
                        buttons: [
                            { text: 'Xem lịch sử', onclick: 'closeNotification(); closeTopUpModal(); openTransactionHistory();', class: 'notification-btn-primary' },
                            { text: 'Đóng', onclick: 'closeNotification()', class: '' }
                        ]
                    }
                );
                return;
            }
            
            // Show waiting notification
            showNotification(
                'Đã ghi nhận yêu cầu nạp tiền',
                `Số tiền: ${formatCurrency(amount)}\n\n` +
                `Đợi cho đến khi giao dịch của bạn được hoàn thành.\n\n` +
                `Chúng tôi sẽ xử lý và cập nhật số dư của bạn trong thời gian sớm nhất.`,
                'info',
                {
                    buttons: [
                        { 
                            text: 'Xác nhận', 
                            onclick: `processTopUpRequest(${amount})`, 
                            class: 'notification-btn-primary' 
                        },
                        { text: 'Hủy', onclick: 'closeNotification()', class: '' }
                    ]
                }
            );
        }
        
        async function processTopUpRequest(amount) {
            if (!currentUser || !currentUser.email) {
                showNotification('Lỗi', 'Vui lòng đăng nhập lại!', 'error');
                return;
            }
            
            // Save transaction to history
            const transaction = {
                id: 'TXN-' + Date.now(),
                type: 'topup',
                amount: amount,
                status: 'pending', // pending, completed, cancelled
                createdAt: new Date().toISOString(),
                description: `Nạp tiền ${formatCurrency(amount)}`
            };
            
            // Get user transactions
            const userTransactions = JSON.parse(localStorage.getItem(`store_transactions_${currentUser.email}`) || '[]');
            userTransactions.push(transaction);
            localStorage.setItem(`store_transactions_${currentUser.email}`, JSON.stringify(userTransactions));
            
            // Save to server (for admin to see)
            try {
                await saveTransactionToServer(transaction);
                console.log('Transaction saved to server:', transaction);
            } catch (error) {
                console.error('Error saving transaction to server:', error);
                // Continue anyway - transaction is saved locally
            }
            
            closeNotification();
            closeTopUpModal();
            
            showNotification(
                'Thành công',
                `Yêu cầu nạp tiền ${formatCurrency(amount)} đã được ghi nhận.\n\nVui lòng đợi admin xử lý!`,
                'success',
                { timeout: 3000 }
            );
        }
        
        // Save transaction to server
        async function saveTransactionToServer(transaction) {
            if (!currentUser || !currentUser.email) {
                console.warn('Cannot save transaction: No current user');
                return;
            }
            
            try {
                console.log('Saving transaction to server:', transaction);
                const response = await fetch(`${API_BASE_URL}/transactions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ...transaction,
                        userEmail: currentUser.email,
                        userName: currentUser.name || currentUser.email
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('Transaction saved successfully:', result);
                } else {
                    const errorText = await response.text();
                    console.error('Failed to save transaction:', response.status, errorText);
                }
            } catch (error) {
                console.error('Error saving transaction to server:', error);
                throw error; // Re-throw to let caller know it failed
            }
        }
        
        function checkLoginBeforeAction(callback) {
            if (!currentUser) {
                document.getElementById('login-modal').style.display = 'flex';
                return;
            }
            callback();
        }
        
        function initializeGoogleSignIn() {
            // Render sign-in buttons only once
            if (!buttonsRendered) {
                renderGoogleSignInButton('google-signin-container');
                renderGoogleSignInButton('google-signin-modal');
                buttonsRendered = true;
            }
            
            // Try to initialize Appwrite if not already done
            if (!account) {
                const initialized = initializeAppwrite();
                if (!initialized) {
                    // Wait for Appwrite SDK to load
                setTimeout(initializeGoogleSignIn, 100);
                return;
                }
            }
            
            // Check if user is already logged in
            if (account) {
                checkUserSession();
            }
        }
        
        function renderGoogleSignInButton(containerId) {
            const container = document.getElementById(containerId);
            if (!container) {
                return;
            }
            
            // Ensure container is visible
            if (containerId === 'google-signin-container') {
                container.style.display = 'flex';
            }
            
            // Clear existing content
            container.innerHTML = '';
            
            // Create button
            const button = document.createElement('button');
            button.className = 'google-signin-btn';
            button.type = 'button'; // Prevent form submission
            button.innerHTML = `
                <svg width="18" height="18" xmlns="http://www.w3.org/2000/svg">
                    <g fill="#000" fill-rule="evenodd">
                        <path d="M9 3.48c1.69 0 2.83.73 3.48 1.34l2.54-2.48C13.46.89 11.43 0 9 0 5.48 0 2.44 2.02.96 4.96l2.91 2.26C4.6 5.05 6.62 3.48 9 3.48z" fill="#EA4335"/>
                        <path d="M17.64 9.2c0-.74-.06-1.28-.19-1.84H9v3.34h4.96c-.21 1.18-.84 2.18-1.79 2.91l2.78 2.15c2.17-2 3.69-4.94 3.69-8.56z" fill="#4285F4"/>
                        <path d="M3.88 10.78A5.54 5.54 0 0 1 3.58 9c0-.62.11-1.22.29-1.78L.96 4.96A9.008 9.008 0 0 0 0 9c0 1.45.35 2.82.96 4.04l2.92-2.26z" fill="#FBBC05"/>
                        <path d="M9 18c2.43 0 4.47-.8 5.96-2.18l-2.78-2.15c-.76.53-1.78.9-3.18.9-2.38 0-4.4-1.57-5.12-3.74L.96 13.04C2.45 15.98 5.48 18 9 18z" fill="#34A853"/>
                    </g>
                </svg>
                <span>Đăng nhập với Google</span>
            `;
            button.onclick = handleGoogleSignIn;
            container.appendChild(button);
        }
        
        async function handleGoogleSignIn() {
            // Check if Appwrite SDK is loaded
            if (!window.AppwriteSDK || !window.appwriteSDKLoaded) {
                alert('Appwrite SDK chưa được tải. Vui lòng:\n1. Kiểm tra kết nối internet\n2. Làm mới trang và đợi một chút\n3. Kiểm tra Console (F12) để xem lỗi');
                return;
            }
            
            // Check if running from file:// protocol (not supported by Appwrite OAuth)
            if (window.location.protocol === 'file:') {
                const message = '⚠️ Bạn đang mở file trực tiếp từ máy tính (file://).\n\n' +
                    'Appwrite OAuth yêu cầu chạy qua web server (HTTP/HTTPS).\n\n' +
                    'Vui lòng chạy một trong các cách sau:\n\n' +
                    '1. VS Code: Cài extension "Live Server" và click "Go Live"\n' +
                    '2. Python: python -m http.server 8000\n' +
                    '3. Node.js: npx http-server\n\n' +
                    'Sau đó mở http://localhost:8000/store.html';
                alert(message);
                return;
            }
            
            // Check if origin is valid (not null or empty)
            if (!window.location.origin || window.location.origin === 'null') {
                alert('⚠️ Không thể xác định URL hiện tại. Vui lòng chạy website qua web server (localhost).');
                return;
            }
            
            // Try to initialize Appwrite if not already done
            if (!account) {
                const initialized = initializeAppwrite();
                if (!initialized) {
                    alert('Không thể khởi tạo Appwrite. Vui lòng kiểm tra Console (F12) để xem lỗi chi tiết.');
                    return;
                }
            }
            
            try {
                // Get Appwrite SDK reference
                const AppwriteSDK = window.AppwriteSDK;
                
                // Get base URL (production domain or localhost for development)
                let baseUrl = window.OAUTH_BASE_URL;
                
                // Fallback: determine base URL if not set
                if (!baseUrl) {
                    if (window.location.hostname === 'www.thelazy.store' || window.location.hostname === 'thelazy.store') {
                        baseUrl = 'https://www.thelazy.store';
                    } else if (window.location.protocol === 'file:') {
                        const port = window.location.port || '5173';
                        baseUrl = `http://localhost:${port}`;
                    } else {
                        baseUrl = window.location.origin;
                    }
                }
                
                // Build OAuth redirect URLs
                const successUrl = baseUrl + window.location.pathname;
                const failureUrl = baseUrl + window.location.pathname + '?error=auth_failed';
                
                // Validate URLs
                if (!successUrl.startsWith('http://') && !successUrl.startsWith('https://')) {
                    alert('⚠️ URL không hợp lệ: ' + successUrl + '\n\nVui lòng chạy website qua web server (localhost) hoặc trên domain thelazy.store.');
                    return;
                }
                
                console.log('Initiating Google OAuth with:', {
                    successUrl: successUrl,
                    failureUrl: failureUrl,
                    baseUrl: baseUrl,
                    environment: baseUrl.includes('thelazy.store') ? 'Production' : 'Development'
                });
                
                // Important: Make sure these URLs are registered in:
                // 1. Appwrite Console → Settings → Platforms
                //    - Production: Add https://www.thelazy.store
                //    - Development: Add localhost with your port
                // 2. Google Cloud Console → APIs & Services → Credentials → OAuth 2.0 Client IDs → Authorized redirect URIs
                //    Add: https://sgp.cloud.appwrite.io/v1/account/sessions/oauth2/google
                console.log('⚠️ IMPORTANT: Make sure these URLs are registered:');
                console.log('   Appwrite Platform:', successUrl);
                console.log('   Google OAuth Redirect URI:', 'https://sgp.cloud.appwrite.io/v1/account/sessions/oauth2/google');
                
                // Create OAuth2 session with Google
                account.createOAuth2Session(
                    AppwriteSDK.OAuthProvider.Google,
                    successUrl,
                    failureUrl
                );
            } catch (error) {
                console.error('Error initiating Google sign-in:', error);
                alert('Có lỗi xảy ra khi đăng nhập:\n' + (error.message || error.toString()) + '\n\nVui lòng kiểm tra Console (F12) để xem chi tiết.');
            }
        }
        
        async function checkUserSession() {
            // Try to initialize Appwrite if not already done
            if (!account) {
                const initialized = initializeAppwrite();
                if (!initialized) {
                    return;
                }
            }
            
            try {
                const user = await account.get();
            
            currentUser = {
                    email: user.email,
                    name: user.name || user.email,
                    picture: '', // Appwrite doesn't provide picture by default
                    sub: user.$id
                };
                
                // Check if user is blacklisted
                const isBlacklisted = await checkBlacklist(user.email);
                if (isBlacklisted) {
                    console.log('❌ User is blacklisted:', user.email);
                    showBannedModal();
                    return;
                }
                
                // Load balance from server first, then fallback to localStorage
                try {
                    const email = encodeURIComponent(user.email);
                    const balanceResponse = await fetch(`${API_BASE_URL}/users/balance?email=${email}`);
                    if (balanceResponse.ok) {
                        const balanceData = await balanceResponse.json();
                        userBalance = balanceData.balance || 0;
                        console.log('Balance loaded from server:', userBalance);
                    } else {
                        // Fallback to localStorage
            const savedBalance = localStorage.getItem('store_balance');
            userBalance = savedBalance ? parseFloat(savedBalance) : 0;
                        console.log('Balance loaded from localStorage:', userBalance);
                    }
                } catch (error) {
                    console.error('Error loading balance:', error);
                    // Fallback to localStorage
                    const savedBalance = localStorage.getItem('store_balance');
                    userBalance = savedBalance ? parseFloat(savedBalance) : 0;
                }
            
            saveUserData();
                
                // Update balance display immediately
                const balanceEl = document.getElementById('user-balance');
                if (balanceEl) {
                    balanceEl.textContent = formatCurrency(userBalance);
                    console.log('Balance displayed:', userBalance);
                }
                
            showUserMenu();
                
                // Force refresh admin panel visibility after login
                setTimeout(() => {
                    const adminBtn = document.getElementById('admin-panel-btn');
                    if (adminBtn) {
                        const adminStatus = isAdmin();
                        console.log('Post-login admin check:', {
                            isAdmin: adminStatus,
                            userEmail: currentUser?.email,
                            adminEmail: ADMIN_EMAIL
                        });
                        
                        if (adminStatus) {
                            adminBtn.removeAttribute('style');
                            adminBtn.style.display = 'block';
                            console.log('✅ Admin panel button is now visible after login');
                        } else {
                            adminBtn.style.display = 'none';
                        }
                    }
                }, 200);
                
                // Check for auto-renewal subscriptions
                checkAutoRenewalSubscriptions();
                
            document.getElementById('login-modal').style.display = 'none';
            } catch (error) {
                // User is not logged in, show login button
                console.log('User not logged in');
            }
        }
        
        // Admin Panel Functions
        function openAdminPanel() {
            if (!isAdmin()) {
                alert('Bạn không có quyền truy cập Admin Panel!');
                return;
            }
            document.getElementById('admin-modal').style.display = 'flex';
            document.body.style.overflow = 'hidden';
            loadAdminOrders();
        }
        
        function closeAdminPanel() {
            document.getElementById('admin-modal').style.display = 'none';
            document.body.style.overflow = '';
        }
        
        function loadAdminOrders() {
            const ordersList = document.getElementById('admin-orders-list');
            if (!ordersList) return;
            
            // Sort orders by date (newest first)
            const sortedOrders = [...allOrders].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            if (sortedOrders.length === 0) {
                ordersList.innerHTML = '<p style="text-align: center; padding: 2rem; color: #999;">Chưa có đơn hàng nào</p>';
                return;
            }
            
            ordersList.innerHTML = sortedOrders.map(order => {
                const statusClass = {
                    'pending': 'order-status-pending',
                    'paid': 'order-status-paid',
                    'cancelled': 'order-status-cancelled'
                }[order.status] || '';
                
                const statusText = {
                    'pending': 'Chờ thanh toán',
                    'paid': 'Đã thanh toán',
                    'cancelled': 'Đã hủy'
                }[order.status] || order.status;
                
                const itemsHtml = order.items.map(item => 
                    `<div>${item.name} x${item.quantity} - ${formatCurrency(item.price * item.quantity)}</div>`
                ).join('');
                
                return `
                    <div class="admin-order-item">
                        <div class="admin-order-header">
                            <div>
                                <strong>Mã đơn: ${order.code}</strong>
                                <div style="font-size: 0.9rem; color: #666; margin-top: 0.25rem;">
                                    ${order.userName} (${order.userEmail})
                                </div>
                            </div>
                            <span class="order-status ${statusClass}">${statusText}</span>
                        </div>
                        <div class="admin-order-items">${itemsHtml}</div>
                        <div class="admin-order-footer">
                            <strong>Tổng: ${formatCurrency(order.total)}</strong>
                            <div class="admin-order-actions">
                                ${order.status === 'pending' ? `
                                    <button class="admin-btn-small admin-btn-success" onclick="adminAcceptPayment('${order.code}')">
                                        <i class="fas fa-check"></i> Xác nhận thanh toán
                                    </button>
                                    <button class="admin-btn-small admin-btn-danger" onclick="adminCancelPayment('${order.code}')">
                                        <i class="fas fa-times"></i> Hủy đơn
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                        <div style="font-size: 0.85rem; color: #999; margin-top: 0.5rem;">
                            ${new Date(order.createdAt).toLocaleString('vi-VN')}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function adminAcceptPayment(orderCode) {
            if (!isAdmin()) {
                alert('Bạn không có quyền!');
                return;
            }
            
            if (!confirm('Xác nhận thanh toán cho đơn hàng ' + orderCode + '?')) {
                return;
            }
            
            const order = allOrders.find(o => o.code === orderCode);
            if (!order) {
                alert('Không tìm thấy đơn hàng!');
                return;
            }
            
            order.status = 'paid';
            order.updatedAt = new Date().toISOString();
            localStorage.setItem('store_orders', JSON.stringify(allOrders));
            
            alert('Đã xác nhận thanh toán!');
            loadAdminOrders();
        }
        
        function adminCancelPayment(orderCode) {
            if (!isAdmin()) {
                alert('Bạn không có quyền!');
                return;
            }
            
            if (!confirm('Hủy đơn hàng ' + orderCode + '?')) {
                return;
            }
            
            const order = allOrders.find(o => o.code === orderCode);
            if (!order) {
                alert('Không tìm thấy đơn hàng!');
                return;
            }
            
            order.status = 'cancelled';
            order.updatedAt = new Date().toISOString();
            localStorage.setItem('store_orders', JSON.stringify(allOrders));
            
            alert('Đã hủy đơn hàng!');
            loadAdminOrders();
        }
        
        async function adminAddMoney() {
            if (!isAdmin()) {
                showNotification('Lỗi', 'Bạn không có quyền!', 'error');
                return;
            }
            
            const email = document.getElementById('admin-user-email').value.trim();
            const amount = parseFloat(document.getElementById('admin-amount').value);
            
            if (!email || !amount || amount <= 0) {
                showNotification('Lỗi', 'Vui lòng nhập đầy đủ thông tin hợp lệ!', 'error');
                return;
            }
            
            try {
                // Get current balance from server
                const emailEncoded = encodeURIComponent(email);
                const response = await fetch(`${API_BASE_URL}/users/balance?email=${emailEncoded}`);
                const data = await response.ok ? await response.json() : { balance: 0 };
                const currentBalance = data.balance || 0;
                const newBalance = currentBalance + amount;
                
                // Update balance on server
                const updateResponse = await fetch(`${API_BASE_URL}/users/balance?email=${emailEncoded}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ balance: newBalance })
                });
                
                if (!updateResponse.ok) {
                    throw new Error('Failed to update balance');
                }
                
                // Update local storage as backup
                const userKey = `store_balance_${email}`;
                localStorage.setItem(userKey, newBalance.toString());
                
                // Update current user balance if it's them
                if (currentUser && currentUser.email === email) {
                    userBalance = newBalance;
                    document.getElementById('user-balance').textContent = formatCurrency(userBalance);
                    saveUserData();
                }
                
                showNotification(
                    'Thành công',
                    `Đã thêm ${formatCurrency(amount)} cho ${email}\nSố dư mới: ${formatCurrency(newBalance)}`,
                    'success',
                    { timeout: 3000 }
                );
                
                document.getElementById('admin-user-email').value = '';
                document.getElementById('admin-amount').value = '';
            } catch (error) {
                console.error('Error adding money:', error);
                showNotification('Lỗi', 'Không thể thêm tiền. Vui lòng thử lại!', 'error');
            }
        }
        
        // Transaction History Functions
        function openTransactionHistory() {
            if (!currentUser) {
                alert('Vui lòng đăng nhập để xem lịch sử giao dịch!');
                return;
            }
            document.getElementById('transaction-modal').style.display = 'flex';
            document.body.style.overflow = 'hidden';
            loadTransactionHistory();
        }
        
        function closeTransactionHistory() {
            document.getElementById('transaction-modal').style.display = 'none';
            document.body.style.overflow = '';
        }
        
        function loadTransactionHistory() {
            const historyList = document.getElementById('transaction-history-list');
            if (!historyList || !currentUser) return;
            
            const userTransactions = JSON.parse(localStorage.getItem(`store_transactions_${currentUser.email}`) || '[]');
            
            if (userTransactions.length === 0) {
                historyList.innerHTML = '<p style="text-align: center; padding: 2rem; color: #999;">Chưa có giao dịch nào</p>';
                return;
            }
            
            // Sort by date (newest first)
            const sortedTransactions = [...userTransactions].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            historyList.innerHTML = sortedTransactions.map(transaction => {
                const statusClass = {
                    'pending': 'transaction-status-pending',
                    'completed': 'transaction-status-completed',
                    'cancelled': 'transaction-status-cancelled'
                }[transaction.status] || '';
                
                const statusText = {
                    'pending': 'Đang chờ xử lý',
                    'completed': 'Hoàn thành',
                    'cancelled': 'Đã hủy'
                }[transaction.status] || transaction.status;
                
                return `
                    <div class="transaction-item">
                        <div class="transaction-header">
                            <div>
                                <strong>${transaction.description}</strong>
                                <div style="font-size: 0.9rem; color: #666; margin-top: 0.25rem;">
                                    ${new Date(transaction.createdAt).toLocaleString('vi-VN')}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 1.2rem; font-weight: 600; color: #4caf50;">
                                    +${formatCurrency(transaction.amount)}
                                </div>
                                <span class="transaction-status ${statusClass}">${statusText}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Admin tab switching
        function initAdminTabs() {
            document.querySelectorAll('.admin-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.dataset.tab;
                    
                    // Update tab buttons
                    document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    // Update tab content
                    document.querySelectorAll('.admin-tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    document.getElementById(`admin-${tabName}-tab`).classList.add('active');
                    
                    // Load data for specific tab
                    if (tabName === 'transactions') {
                        loadAdminTransactions();
                    } else if (tabName === 'blacklist') {
                        loadBlacklist();
                    }
                });
            });
        }
        
        // Check if user is blacklisted
        async function checkBlacklist(email) {
            try {
                const emailEncoded = encodeURIComponent(email);
                const response = await fetch(`${API_BASE_URL}/users/blacklist?email=${emailEncoded}`);
                
                if (response.ok) {
                    const data = await response.json();
                    return data.isBlacklisted || false;
                }
                return false;
            } catch (error) {
                console.error('Error checking blacklist:', error);
                return false;
            }
        }
        
        // Show banned modal
        function showBannedModal() {
            const bannedModal = document.getElementById('banned-modal');
            if (bannedModal) {
                bannedModal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }
        }
        
        // Close banned modal
        function closeBannedModal() {
            const bannedModal = document.getElementById('banned-modal');
            if (bannedModal) {
                bannedModal.style.display = 'none';
                document.body.style.overflow = '';
            }
        }
        
        // Handle logout (for banned users)
        function handleLogout() {
            logout(); // Use existing logout function
        }
        
        // Admin: Add to blacklist
        async function adminAddToBlacklist() {
            if (!isAdmin()) {
                showNotification('Lỗi', 'Bạn không có quyền!', 'error');
                return;
            }
            
            const email = document.getElementById('blacklist-email').value.trim();
            if (!email) {
                showNotification('Lỗi', 'Vui lòng nhập email!', 'error');
                return;
            }
            
            try {
                const emailEncoded = encodeURIComponent(email);
                const response = await fetch(`${API_BASE_URL}/users/blacklist?email=${emailEncoded}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok) {
                    showNotification('Thành công', `Đã thêm ${email} vào blacklist!`, 'success', { timeout: 2000 });
                    document.getElementById('blacklist-email').value = '';
                    loadBlacklist();
                } else {
                    throw new Error('Failed to add to blacklist');
                }
            } catch (error) {
                console.error('Error adding to blacklist:', error);
                showNotification('Lỗi', 'Không thể thêm vào blacklist. Vui lòng thử lại!', 'error');
            }
        }
        
        // Admin: Remove from blacklist
        async function adminRemoveFromBlacklist() {
            if (!isAdmin()) {
                showNotification('Lỗi', 'Bạn không có quyền!', 'error');
                return;
            }
            
            const email = document.getElementById('blacklist-email').value.trim();
            if (!email) {
                showNotification('Lỗi', 'Vui lòng nhập email!', 'error');
                return;
            }
            
            try {
                const emailEncoded = encodeURIComponent(email);
                const response = await fetch(`${API_BASE_URL}/users/blacklist?email=${emailEncoded}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok) {
                    showNotification('Thành công', `Đã gỡ ${email} khỏi blacklist!`, 'success', { timeout: 2000 });
                    document.getElementById('blacklist-email').value = '';
                    loadBlacklist();
                } else {
                    throw new Error('Failed to remove from blacklist');
                }
            } catch (error) {
                console.error('Error removing from blacklist:', error);
                showNotification('Lỗi', 'Không thể gỡ khỏi blacklist. Vui lòng thử lại!', 'error');
            }
        }
        
        // Load blacklist
        async function loadBlacklist() {
            if (!isAdmin()) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/users/blacklist-list`);
                if (response.ok) {
                    const data = await response.json();
                    const blacklist = data.blacklist || [];
                    
                    const blacklistList = document.getElementById('blacklist-list');
                    if (!blacklistList) return;
                    
                    if (blacklist.length === 0) {
                        blacklistList.innerHTML = '<p style="text-align: center; padding: 2rem; color: #666;">Chưa có người dùng nào bị blacklist</p>';
                        return;
                    }
                    
                    blacklistList.innerHTML = blacklist.map(user => `
                        <div class="admin-order-item">
                            <div class="admin-order-header">
                                <div>
                                    <strong>${user.email}</strong>
                                    <div style="font-size: 0.9rem; color: #666; margin-top: 0.25rem;">
                                        Bị cấm: ${new Date(user.blacklistedAt).toLocaleString('vi-VN')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading blacklist:', error);
            }
        }
        
        function loadAdminTransactions() {
            const transactionsList = document.getElementById('admin-transactions-list');
            if (!transactionsList) return;
            
            // Get all transactions from all users
            let allTransactions = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('store_transactions_')) {
                    const userTransactions = JSON.parse(localStorage.getItem(key) || '[]');
                    const userEmail = key.replace('store_transactions_', '');
                    userTransactions.forEach(txn => {
                        allTransactions.push({...txn, userEmail});
                    });
                }
            }
            
            // Sort by date (newest first)
            allTransactions.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            if (allTransactions.length === 0) {
                transactionsList.innerHTML = '<p style="text-align: center; padding: 2rem; color: #999;">Chưa có giao dịch nào</p>';
                return;
            }
            
            transactionsList.innerHTML = allTransactions.map(transaction => {
                const statusClass = {
                    'pending': 'transaction-status-pending',
                    'completed': 'transaction-status-completed',
                    'cancelled': 'transaction-status-cancelled'
                }[transaction.status] || '';
                
                const statusText = {
                    'pending': 'Đang chờ xử lý',
                    'completed': 'Hoàn thành',
                    'cancelled': 'Đã hủy'
                }[transaction.status] || transaction.status;
                
                return `
                    <div class="admin-transaction-item">
                        <div class="admin-transaction-header">
                            <div>
                                <strong>${transaction.description}</strong>
                                <div style="font-size: 0.9rem; color: #666; margin-top: 0.25rem;">
                                    ${transaction.userEmail}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 1.2rem; font-weight: 600; color: #4caf50;">
                                    +${formatCurrency(transaction.amount)}
                                </div>
                                <span class="transaction-status ${statusClass}">${statusText}</span>
                            </div>
                        </div>
                        <div style="font-size: 0.85rem; color: #999; margin-top: 0.5rem;">
                            ${new Date(transaction.createdAt).toLocaleString('vi-VN')}
                        </div>
                        ${transaction.status === 'pending' ? `
                            <div class="admin-transaction-actions" style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                                <button class="admin-btn-small admin-btn-success" onclick="adminCompleteTransaction('${transaction.id}', '${transaction.userEmail}')">
                                    <i class="fas fa-check"></i> Xác nhận
                                </button>
                                <button class="admin-btn-small admin-btn-danger" onclick="adminCancelTransaction('${transaction.id}', '${transaction.userEmail}')">
                                    <i class="fas fa-times"></i> Hủy
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }
        
        async function adminCompleteTransaction(transactionId, userEmail) {
            if (!isAdmin()) {
                showNotification('Lỗi', 'Bạn không có quyền!', 'error');
                return;
            }
            
            showNotification(
                'Xác nhận giao dịch',
                `Bạn có chắc muốn xác nhận giao dịch này?`,
                'warning',
                {
                    buttons: [
                        { 
                            text: 'Xác nhận', 
                            onclick: `confirmCompleteTransaction('${transactionId}', '${userEmail}')`, 
                            class: 'notification-btn-primary' 
                        },
                        { text: 'Hủy', onclick: 'closeNotification()', class: '' }
                    ]
                }
            );
        }
        
        async function confirmCompleteTransaction(transactionId, userEmail) {
            try {
                // Get transaction from local storage first to get amount
                const userTransactions = JSON.parse(localStorage.getItem(`store_transactions_${userEmail}`) || '[]');
                const transaction = userTransactions.find(t => t.id === transactionId);
                
                if (!transaction) {
                    showNotification('Lỗi', 'Không tìm thấy giao dịch!', 'error');
                    return;
                }
                
                // Update transaction status on server
                const response = await fetch(`${API_BASE_URL}/transactions/${transactionId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        status: 'completed',
                        userEmail: userEmail
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to update transaction');
                }
                
                // Update local storage
                transaction.status = 'completed';
                transaction.completedAt = new Date().toISOString();
                localStorage.setItem(`store_transactions_${userEmail}`, JSON.stringify(userTransactions));
                
                // Update current user balance if it's them
                if (currentUser && currentUser.email === userEmail) {
                    await getCurrentBalance(); // Refresh balance from server
                }
                
                closeNotification();
                showNotification('Thành công', 'Đã xác nhận giao dịch và cập nhật số dư!', 'success', { timeout: 2000 });
                loadAdminTransactions();
            } catch (error) {
                console.error('Error completing transaction:', error);
                showNotification('Lỗi', 'Không thể xác nhận giao dịch. Vui lòng thử lại!', 'error');
            }
        }
        
        async function adminCancelTransaction(transactionId, userEmail) {
            if (!isAdmin()) {
                showNotification('Lỗi', 'Bạn không có quyền!', 'error');
                return;
            }
            
            showNotification(
                'Hủy giao dịch',
                `Bạn có chắc muốn hủy giao dịch này?`,
                'warning',
                {
                    buttons: [
                        { 
                            text: 'Xác nhận hủy', 
                            onclick: `confirmCancelTransaction('${transactionId}', '${userEmail}')`, 
                            class: 'notification-btn-danger' 
                        },
                        { text: 'Đóng', onclick: 'closeNotification()', class: '' }
                    ]
                }
            );
        }
        
        async function confirmCancelTransaction(transactionId, userEmail) {
            try {
                // Update transaction status on server
                const response = await fetch(`${API_BASE_URL}/transactions/${transactionId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        status: 'cancelled',
                        userEmail: userEmail
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to cancel transaction');
                }
                
                // Update local storage
                const userTransactions = JSON.parse(localStorage.getItem(`store_transactions_${userEmail}`) || '[]');
                const transaction = userTransactions.find(t => t.id === transactionId);
                
                if (transaction) {
                    transaction.status = 'cancelled';
                    transaction.cancelledAt = new Date().toISOString();
                    localStorage.setItem(`store_transactions_${userEmail}`, JSON.stringify(userTransactions));
                }
                
                closeNotification();
                showNotification('Thành công', 'Đã hủy giao dịch!', 'success', { timeout: 2000 });
                loadAdminTransactions();
            } catch (error) {
                console.error('Error cancelling transaction:', error);
                showNotification('Lỗi', 'Không thể hủy giao dịch. Vui lòng thử lại!', 'error');
            }
        }
        
        // Auto Robux Subscription Functions
        let selectedPlanPrice = null;
        
        function openAutoRobuxModal() {
            checkLoginBeforeAction(() => {
                // Check for pending transactions
                if (hasPendingTransaction()) {
                    showNotification(
                        'Giao dịch đang chờ xử lý',
                        'Bạn có giao dịch nạp tiền đang chờ xử lý. Vui lòng đợi giao dịch được xác nhận hoặc hủy trước khi đăng ký gói.',
                        'warning',
                        {
                            buttons: [
                                { text: 'Xem lịch sử', onclick: 'closeNotification(); openTransactionHistory();', class: 'notification-btn-primary' },
                                { text: 'Đóng', onclick: 'closeNotification()', class: '' }
                            ]
                        }
                    );
                    return;
                }
                
                const modal = document.getElementById('subscription-plans-modal');
                modal.style.display = 'flex';
            });
        }
        
        function closeSubscriptionPlansModal() {
            const modal = document.getElementById('subscription-plans-modal');
            modal.style.display = 'none';
        }
        
        async function selectSubscriptionPlan(price) {
            selectedPlanPrice = price;
            
            // Get current balance
            const currentBalance = await getCurrentBalance();
            
            if (currentBalance < price) {
                const shortage = price - currentBalance;
                closeSubscriptionPlansModal();
                showNotification(
                    'Số tiền không đủ',
                    `Số tiền hiện có: ${formatCurrency(currentBalance)}\n` +
                    `Giá gói: ${formatCurrency(price)}\n` +
                    `Thiếu: ${formatCurrency(shortage)}\n\n` +
                    `Vui lòng nạp thêm tiền để tiếp tục.`,
                    'error',
                    {
                        buttons: [
                            { text: 'Nạp tiền', onclick: 'closeNotification(); openTopUpModal();', class: 'notification-btn-primary' },
                            { text: 'Đóng', onclick: 'closeNotification()', class: '' }
                        ]
                    }
                );
                return;
            }
            
            // Show confirmation modal
            closeSubscriptionPlansModal();
            showSubscriptionConfirmModal(price, currentBalance);
        }
        
        function showSubscriptionConfirmModal(price, currentBalance) {
            const modal = document.getElementById('subscription-confirm-modal');
            const infoDiv = document.getElementById('subscription-confirm-info');
            
            const planName = price === 100000 ? 'Gói Cơ Bản' : price === 300000 ? 'Gói Tiêu Chuẩn' : 'Gói Cao Cấp';
            
            infoDiv.innerHTML = `
                <div class="subscription-confirm-details">
                    <div class="confirm-detail-item">
                        <span class="detail-label">Gói đăng ký:</span>
                        <span class="detail-value">${planName}</span>
                    </div>
                    <div class="confirm-detail-item">
                        <span class="detail-label">Giá:</span>
                        <span class="detail-value">${formatCurrency(price)}/tháng</span>
                    </div>
                    <div class="confirm-detail-item">
                        <span class="detail-label">Số tiền hiện tại:</span>
                        <span class="detail-value">${formatCurrency(currentBalance)}</span>
                    </div>
                    <div class="confirm-detail-item">
                        <span class="detail-label">Số dư sau khi đăng ký:</span>
                        <span class="detail-value">${formatCurrency(currentBalance - price)}</span>
                    </div>
                </div>
            `;
            
            modal.style.display = 'flex';
        }
        
        function closeSubscriptionConfirmModal() {
            const modal = document.getElementById('subscription-confirm-modal');
            modal.style.display = 'none';
            selectedPlanPrice = null;
        }
        
        async function confirmSubscription() {
            if (!selectedPlanPrice) {
                showNotification('Lỗi', 'Vui lòng chọn gói trước!', 'error');
                return;
            }
            
            if (!currentUser || !currentUser.email) {
                showNotification('Lỗi', 'Vui lòng đăng nhập trước!', 'error');
                return;
            }
            
            const autoPayment = document.getElementById('auto-payment-checkbox').checked;
            
            // Get latest balance
            const currentBalance = await getCurrentBalance();
            
            if (currentBalance < selectedPlanPrice) {
                closeSubscriptionConfirmModal();
                showNotification(
                    'Số tiền không đủ',
                    `Số tiền hiện có không đủ để đăng ký gói này.`,
                    'error'
                );
                return;
            }
            
            try {
                // Save subscription to server
                const response = await fetch(`${API_BASE_URL}/subscriptions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: currentUser.email,
                        planPrice: selectedPlanPrice,
                        autoPayment: autoPayment,
                        startDate: new Date().toISOString(),
                        nextPaymentDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString() // 30 days from now
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to create subscription');
                }
                
                // Deduct balance
                const newBalance = currentBalance - selectedPlanPrice;
                await updateBalanceOnServer(newBalance);
                userBalance = newBalance;
            saveUserData();
                
                // Update UI
                const balanceEl = document.getElementById('user-balance');
                if (balanceEl) {
                    balanceEl.textContent = formatCurrency(userBalance);
                }
                
                // Save transaction
                await saveTransactionToServer({
                    type: 'subscription',
                    amount: selectedPlanPrice,
                    status: 'completed',
                    description: `Đăng ký gói Robux tự động ${formatCurrency(selectedPlanPrice)}/tháng`,
                    createdAt: new Date().toISOString()
                });
                
                closeSubscriptionConfirmModal();
                showNotification(
                    'Đăng ký thành công!',
                    `Bạn đã đăng ký gói Robux tự động thành công!\n\n` +
                    `Gói: ${formatCurrency(selectedPlanPrice)}/tháng\n` +
                    `Tự động thanh toán: ${autoPayment ? 'Có' : 'Không'}\n\n` +
                    `Robux sẽ được cung cấp mỗi ngày vào gamepass của bạn.`,
                    'success',
                    { timeout: 5000 }
                );
                
                selectedPlanPrice = null;
            } catch (error) {
                console.error('Error creating subscription:', error);
                showNotification('Lỗi', 'Không thể đăng ký gói. Vui lòng thử lại!', 'error');
            }
        }
        
        // Check and process auto-renewal subscriptions
        async function checkAutoRenewalSubscriptions() {
            if (!currentUser || !currentUser.email) return;
            
            try {
                const email = encodeURIComponent(currentUser.email);
                const response = await fetch(`${API_BASE_URL}/subscriptions/check-renewal?email=${email}`);
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.renewed) {
                        showNotification(
                            'Gia hạn tự động',
                            `Gói Robux tự động của bạn đã được gia hạn tự động!\n\n` +
                            `Số tiền đã trừ: ${formatCurrency(data.amount)}\n` +
                            `Số dư còn lại: ${formatCurrency(data.newBalance)}`,
                            'success',
                            { timeout: 5000 }
                        );
                        
                        // Update balance in UI
                        userBalance = data.newBalance;
                        saveUserData();
                        const balanceEl = document.getElementById('user-balance');
                        if (balanceEl) {
                            balanceEl.textContent = formatCurrency(userBalance);
                        }
                    }
                }
            } catch (error) {
                console.error('Error checking auto-renewal:', error);
            }
        }
        
        // User menu toggle
        function toggleUserMenu() {
            const dropdown = document.getElementById('user-dropdown');
            dropdown.classList.toggle('show');
        }
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const userMenu = document.getElementById('user-menu-container');
            const dropdown = document.getElementById('user-dropdown');
            if (userMenu && !userMenu.contains(event.target) && dropdown.classList.contains('show')) {
                dropdown.classList.remove('show');
            }
        });

        // Header scroll behavior
        let lastScroll = 0;
        const nav = document.getElementById('main-nav');
        
        window.addEventListener('scroll', () => {
            const currentScroll = window.pageYOffset;
            
            if (currentScroll <= 10) {
                nav.classList.add('nav-visible');
                nav.classList.remove('nav-hidden');
            } else if (currentScroll > lastScroll && currentScroll > 100) {
                nav.classList.add('nav-hidden');
                nav.classList.remove('nav-visible');
            } else {
                nav.classList.add('nav-visible');
                nav.classList.remove('nav-hidden');
            }
            
            lastScroll = currentScroll;
        });

        // Category filter
        document.addEventListener('DOMContentLoaded', () => {
            // Check if running from file:// and show warning
            if (window.location.protocol === 'file:') {
                console.warn('⚠️ Đang chạy từ file:// - OAuth sẽ không hoạt động!');
                console.warn('Vui lòng chạy qua web server:');
                console.warn('  - VS Code: Cài "Live Server" extension');
                console.warn('  - Python: python -m http.server 8000');
                console.warn('  - Node.js: npx http-server');
                console.warn('Sau đó mở: http://localhost:8000/store.html');
            }
            
            // Initialize Google sign-in buttons immediately
            initializeGoogleSignIn();
            
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentCategory = btn.dataset.category;
                    renderProducts(currentCategory);
                });
            });
            
            loadUserData();
            loadStockFromDB();
            renderProducts();
            updateCart();
            applyTranslations();

            document.getElementById('cart-icon').addEventListener('click', () => {
                checkLoginBeforeAction(openCart);
            });
            document.getElementById('cart-close').addEventListener('click', closeCart);
            document.getElementById('checkout-btn').addEventListener('click', () => {
                checkLoginBeforeAction(checkout);
            });
            document.getElementById('order-modal-close').addEventListener('click', closeOrderModal);
            document.getElementById('user-menu-btn').addEventListener('click', toggleUserMenu);
            document.getElementById('top-up-btn').addEventListener('click', openTopUpModal);
            document.getElementById('topup-modal-close').addEventListener('click', closeTopUpModal);
            document.getElementById('topup-confirm-btn').addEventListener('click', confirmTopUp);
            document.getElementById('logout-btn').addEventListener('click', logout);
            document.getElementById('settings-btn').addEventListener('click', () => {
                alert('Tính năng cài đặt đang được phát triển');
            });
            
            // Transaction history event listeners
            document.getElementById('transaction-history-btn').addEventListener('click', openTransactionHistory);
            document.getElementById('transaction-modal-close').addEventListener('click', closeTransactionHistory);
            
            // Admin panel event listeners
            const adminPanelBtn = document.getElementById('admin-panel-btn');
            if (adminPanelBtn) {
                adminPanelBtn.addEventListener('click', openAdminPanel);
            }
            const adminModalClose = document.getElementById('admin-modal-close');
            if (adminModalClose) {
                adminModalClose.addEventListener('click', closeAdminPanel);
            }
            initAdminTabs();
            
            // Close modals when clicking outside
            document.getElementById('order-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeOrderModal();
                }
            });
            
            document.getElementById('topup-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeTopUpModal();
                }
            });
            
            document.getElementById('transaction-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeTransactionHistory();
                }
            });
            
            document.getElementById('login-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    this.style.display = 'none';
                }
            });

            document.getElementById('cart-sidebar').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeCart();
                }
            });
            
            // Subscription modals event listeners
            const subscriptionPlansModalClose = document.getElementById('subscription-plans-modal-close');
            if (subscriptionPlansModalClose) {
                subscriptionPlansModalClose.addEventListener('click', closeSubscriptionPlansModal);
            }
            
            const subscriptionConfirmModalClose = document.getElementById('subscription-confirm-modal-close');
            if (subscriptionConfirmModalClose) {
                subscriptionConfirmModalClose.addEventListener('click', closeSubscriptionConfirmModal);
            }
            
            document.getElementById('subscription-plans-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeSubscriptionPlansModal();
                }
            });
            
            document.getElementById('subscription-confirm-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeSubscriptionConfirmModal();
                }
            });
        });
    </script>
</body>
</html>

